<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calculadora Apuestas Avanzada ‚Ä¢ Poisson + Mejoras</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    select, input, button { padding: 5px; margin: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #eee; }
    .form-section { display: flex; flex-wrap: wrap; margin-top: 20px; }
    .form-box { flex: 1 1 45%; background: white; margin: 10px; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .actions { margin-top: 20px; text-align: center; }
    .actions button { margin: 0 10px; padding: 10px 20px; }
    .result-box { background: #fff; padding: 15px; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .highlight { font-weight: bold; color: darkgreen; }
  </style>
</head>
<body>
<div class="container">
  <h1>Calculadora de Apuestas Avanzada</h1>

  <div>
    <label for="leagueSelect">Competencia:</label>
    <select id="leagueSelect">
      <option value="">-- Selecciona liga --</option>
    </select>
  </div>

  <div class="form-section">
    <div class="form-box">
      <h3>Equipo Local</h3>
      <select id="teamHome"><option value="">-- Selecciona equipo --</option></select><br>
      <label>Posici√≥n: <input id="posHome" type="text" disabled></label><br>
      <label>GF: <input id="gfHome" type="text" disabled></label><br>
      <label>GC: <input id="gaHome" type="text" disabled></label><br>
      <label>Forma (G-E-P): <input id="formHome" type="text"></label><br>
      <div id="formHomeTeam"></div>
      <div id="formHomeBox"></div>
    </div>
    <div class="form-box">
      <h3>Equipo Visitante</h3>
      <select id="teamAway"><option value="">-- Selecciona equipo --</option></select><br>
      <label>Posici√≥n: <input id="posAway" type="text" disabled></label><br>
      <label>GF: <input id="gfAway" type="text" disabled></label><br>
      <label>GC: <input id="gaAway" type="text" disabled></label><br>
      <label>Forma (G-E-P): <input id="formAway" type="text"></label><br>
      <div id="formAwayTeam"></div>
      <div id="formAwayBox"></div>
    </div>
  </div>

  <div class="form-section">
    <div class="form-box">
      <h3>Par√°metros adicionales</h3>
      <label>Ventaja local: <input id="homeAdvantage" type="number" step="0.1" value="1.0"></label><br>
      <label>Peso forma: <input id="formWeight" type="number" step="0.1" value="0.5"></label><br>
      <label>Dixon-Coles param: <input id="dixonColesParam" type="number" step="0.1" value="0.0"></label><br>
      <label>M√°x. equipos (filtro): <input id="maxTeams" type="number" value="20"></label>
    </div>
    <div class="form-box">
      <h3>Gesti√≥n de Bankroll</h3>
      <label>Bankroll inicial: <input id="bankroll" type="number" value="1000"></label>
      <button id="saveBank">Guardar</button>
    </div>
  </div>

  <div class="actions">
    <button id="recalc">Recalcular</button>
    <button id="reset">Reset</button>
    <button id="clearAll">Limpiar Todo</button>
  </div>

  <div class="result-box">
    <h3>Resultados & Recomendaciones</h3>
    <div id="results"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const formatPct = x => (100 * (isFinite(x) ? x : 0)).toFixed(1) + '%';
const formatDec = x => (isFinite(x) ? x.toFixed(2) : '0.00');
function parseNumberString(val){ const s=String(val||'').toString().replace(/,/g,'.'); const n=Number(s); return isFinite(n)?n:0; }
function toDecimalOdds(v){ const a=parseFloat(String(v).replace(/,/g,'.')); return isNaN(a)||a<=0?1.01:a; }

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyP6dc9ww4I9kw26fQCc0gAyEtYbQVg6DsoAtlnxqhFFJClOrHoudM8PdnBnT9YBopSlA/exec";
let teamsByLeague = {};

const leagueNames = {
  "WC":"FIFA World Cup","CL":"UEFA Champions League","BL1":"Bundesliga","DED":"Eredivisie","BSA":"Campeonato Brasileiro",
  "PD":"Liga Espa√±ola","FL1":"Ligue 1","ELC":"Championship","PPL":"Primeira Liga","EC":"European Championship","SA":"Serie A","PL":"Premier League"
};

function normalizeTeam(raw){
  if(!raw) return null;
  const r = {};
  r.name = raw.name || raw.Team || raw.team?.name || raw.teamName || raw['Equipo'] || '';
  r.pos = raw.pos || raw.position || raw.rank || raw['Pos'] || null;
  r.gf = parseNumberString(raw.gf || raw.goalsFor || raw.GF);
  r.ga = parseNumberString(raw.ga || raw.goalsAgainst || raw.GC);
  r.pj = parseNumberString(raw.PJ || raw.played || raw.matches);
  r.g  = parseNumberString(raw.G || raw.won || raw.W);
  r.e  = parseNumberString(raw.E || raw.draw || raw.D);
  r.p  = parseNumberString(raw.P || raw.lost || raw.L);
  return r;
}

async function fetchTeams(){
  try{
    const res = await fetch(WEBAPP_URL);
    if(!res.ok) throw new Error('fetch fall√≥ ' + res.status);
    const data = await res.json();
    const normalized = {};
    for(const key in data){
      const arr = data[key] || [];
      normalized[key] = arr.map(x => normalizeTeam(x));
    }
    return normalized;
  }catch(err){
    console.error('Error fetching teams:', err);
    return {};
  }
}

async function init(){
  teamsByLeague = await fetchTeams();
  const leagueCodes = Object.keys(teamsByLeague);
  leagueCodes.forEach(code => {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = leagueNames[code] || code;
    $('leagueSelect').appendChild(opt);
  });
  const saved = localStorage.getItem('bankroll');
  if(saved) $('bankroll').value = saved;
  $('leagueSelect').addEventListener('change', onLeagueChange);
  $('teamHome').addEventListener('change', ()=>fillTeamData($('teamHome').value, $('leagueSelect').value,'Home'));
  $('teamAway').addEventListener('change', ()=>fillTeamData($('teamAway').value, $('leagueSelect').value,'Away'));
  $('recalc').addEventListener('click', calculateAll);
  $('reset').addEventListener('click', ()=>location.reload());
  $('clearAll').addEventListener('click', clearAll);
  $('saveBank').addEventListener('click', saveBankrollToStorage);
  ['homeAdvantage','formWeight','dixonColesParam','maxTeams','formHome','formAway']
    .forEach(id => $(id).addEventListener('change', calculateAll));
}
document.addEventListener('DOMContentLoaded', init);

function onLeagueChange(){
  const code = $('leagueSelect').value;
  $('teamHome').innerHTML = '<option value="">-- Selecciona equipo --</option>';
  $('teamAway').innerHTML = '<option value="">-- Selecciona equipo --</option>';
  if(!teamsByLeague[code]) return;
  teamsByLeague[code].forEach(t => {
    const opt1 = document.createElement('option');
    opt1.value = t.name; opt1.textContent = t.name;
    $('teamHome').appendChild(opt1);
    const opt2 = document.createElement('option');
    opt2.value = t.name; opt2.textContent = t.name;
    $('teamAway').appendChild(opt2);
  });
}

function findTeam(leagueCode, teamName){
  if(!teamsByLeague[leagueCode]) return null;
  return teamsByLeague[leagueCode].find(t => t.name === teamName) || null;
}

function fillTeamData(teamName, leagueCode, type){
  if(!teamName) return;
  const t = findTeam(leagueCode, teamName);
  if(!t) return;

  const formString = `${t.g||0}-${t.e||0}-${t.p||0}`; // üëà forma autom√°tica

  if(type === 'Home'){
    $('posHome').value = t.pos || '';
    $('gfHome').value = Number.isFinite(t.gf) ? t.gf : '';
    $('gaHome').value = Number.isFinite(t.ga) ? t.ga : '';
    $('formHome').value = formString;
    $('formHomeTeam').textContent = `Local: ${t.name}`;
    $('formHomeBox').textContent = `PJ: ${t.pj||0} | G: ${t.g||0} | E: ${t.e||0} | P: ${t.p||0}`;
  } else {
    $('posAway').value = t.pos || '';
    $('gfAway').value = Number.isFinite(t.gf) ? t.gf : '';
    $('gaAway').value = Number.isFinite(t.ga) ? t.ga : '';
    $('formAway').value = formString;
    $('formAwayTeam').textContent = `Visitante: ${t.name}`;
    $('formAwayBox').textContent = `PJ: ${t.pj||0} | G: ${t.g||0} | E: ${t.e||0} | P: ${t.p||0}`;
  }
  calculateAll();
}

function clearAll(){
  ['posHome','gfHome','gaHome','formHome','posAway','gfAway','gaAway','formAway'].forEach(id => $(id).value = '');
  $('formHomeTeam').textContent='';
  $('formHomeBox').textContent='';
  $('formAwayTeam').textContent='';
  $('formAwayBox').textContent='';
  $('results').innerHTML='';
}

function saveBankrollToStorage(){
  const val = $('bankroll').value;
  localStorage.setItem('bankroll', val);
  alert('Bankroll guardado: ' + val);
}

// ‚öΩ Aqu√≠ seguir√≠a tu funci√≥n calculateAll() con Poisson, Kelly, etc. 
// No la modifiqu√© porque solo pediste lo de forma autom√°tica.

</script>
</body>
</html>
