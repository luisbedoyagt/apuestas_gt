<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada • Poisson + Mejoras</title>
<style>
:root{
  --gap:12px; --radius:10px; --bg:#0f1220; --card:#191c2f; --muted:rgba(230,233,245,.75);
  --accent: #4f46e5; --accent-2: #6ee7a1; --accent-3: #f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:8px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:var(--card);border:1px solid #2a2e4a;padding:12px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.28)}
label{font-size:13px;opacity:.95}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2e4a;background:transparent;color:inherit}
.row{display:flex;gap:10px}
.row > *{flex:1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}
.btn {padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),#6366f1);color:#fff;font-weight:700;cursor:pointer;transition:all .14s ease}
.btn:hover{transform:translateY(-2px)}
.btn-secondary {background:linear-gradient(135deg,var(--accent-3),#f59e0b);}
.sep{height:1px;background:#2a2e4a;margin:10px 0}
.recs{display:grid;gap:8px}
.table-like{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:6px}
.stat-title{font-size:12px;color:var(--muted);font-weight:600}
.stat-values{font-size:15px;font-weight:700}
.suggest{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(90deg,#062b14, rgba(110,231,161,0.06));border-left:4px solid var(--accent-2);font-weight:700}
.abbrev{font-size:12px;color:var(--muted);margin-top:8px}
.correction-factors {display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;}
.correction-factor {background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; text-align: center;}
.correction-factor .label {font-size: 12px; color: var(--muted);}
.correction-factor .value {font-size: 14px; font-weight: bold;}
@media(max-width:880px){.grid{grid-template-columns:1fr}.table-like{grid-template-columns:1fr}.correction-factors {grid-template-columns: 1fr;}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Calculadora Apuestas Avanzada • Modelo Mejorado</h1>
    <p class="small">Sistema mejorado con factores de corrección, forma reciente y modelo Dixon-Coles</p>
  </div>

  <!-- Banco & Cuotas -->
  <div class="grid">
    <div class="card">
      <h3>Banco mensual</h3>
      <div class="table-like">
        <div>
          <label>Banca actual (Q)</label>
          <input id="bankroll" type="number" value="1000" min="0" step="1"/>
        </div>
        <div>
          <label>Guardar</label><br/>
          <button id="saveBank" class="btn">Guardar banca</button>
        </div>
      </div>
      <div class="sep"></div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button id="recalc" class="btn">Calcular</button>
        <button id="reset" class="btn">Reset valores</button>
        <button id="clearAll" class="btn">Resetear todo</button>
      </div>
    </div>

    <div class="card">
      <h3>Cuotas</h3>
      <div class="table-like">
        <div><label>1X2 - Local</label><input id="oddsHome" type="number" value="2.10" step="0.01" min="1"/></div>
        <div><label>1X2 - Empate</label><input id="oddsDraw" type="number" value="3.40" step="0.01" min="1"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>1X2 - Visitante</label><input id="oddsAway" type="number" value="3.80" step="0.01" min="1"/></div>
        <div><label>BTTS Sí</label><input id="oddsBTTS" type="number" value="1.90" step="0.01" min="1"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>Over 2.5</label><input id="oddsOver25" type="number" value="2.00" step="0.01" min="1"/></div>
        <div></div>
      </div>
      <p class="small" style="margin-top:8px">Consejo: usa decimales. (Americana → decimal antes)</p>
    </div>
  </div>

  <!-- Selección equipos -->
  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>Equipos y estadísticas</h3>
      <div class="table-like">
        <div>
          <label>Liga</label>
          <select id="leagueSelect"><option value="">-- Selecciona liga --</option></select>
        </div>
      </div>

      <div class="table-like" style="margin-top:8px">
        <div>
          <label>Equipo Local</label>
          <select id="teamHome"></select>
        </div>
        <div>
          <label>Equipo Visitante</label>
          <select id="teamAway"></select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="table-like">
        <div>
          <label>Pos Local</label><input id="posHome" type="number" value="-" min="1" step="1"/>
        </div>
        <div>
          <label>Pos Visitante</label><input id="posAway" type="number" value="-" min="1" step="1"/>
        </div>
      </div>

      <div class="sep"></div>

      <div class="table-like">
        <div>
          <label>GF local</label><input id="gfHome" type="number" value="1.6" step="0.01" min="0"/>
        </div>
        <div>
          <label>GC local</label><input id="gaHome" type="number" value="1.1" step="0.01" min="0"/>
        </div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div>
          <label>GF visitante</label><input id="gfAway" type="number" value="1.4" step="0.01" min="0"/>
        </div>
        <div>
          <label>GC visitante</label><input id="gaAway" type="number" value="1.2" step="0.01" min="0"/>
        </div>
      </div>

      <div class="sep"></div>
      
      <h4>Forma reciente (últimos 5 partidos)</h4>
      <div class="table-like" style="margin-top:6px">
        <div>
          <label>Forma Local (G-E-P)</label>
          <input id="formHome" type="text" placeholder="3-1-1" value="3-1-1"/>
        </div>
        <div>
          <label>Forma Visitante (G-E-P)</label>
          <input id="formAway" type="text" placeholder="2-2-1" value="2-2-1"/>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <h4>Factores de Corrección</h4>
      <div class="table-like">
        <div>
          <label>Ventaja local (+%)</label>
          <input id="homeAdvantage" type="number" value="15" step="1" min="0" max="50"/>
        </div>
        <div>
          <label>Peso forma reciente (%)</label>
          <input id="formWeight" type="number" value="30" step="5" min="0" max="100"/>
        </div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div>
          <label>Factor Dixon-Coles (ρ)</label>
          <input id="dixonColesParam" type="number" value="-0.13" step="0.01" min="-0.5" max="0.5"/>
        </div>
        <div>
          <label>Máx. equipos en liga</label>
          <input id="maxTeams" type="number" value="20" step="1" min="10" max="30"/>
        </div>
      </div>

      <div class="sep"></div>

      <h4>Forma general</h4>
      <div class="table-like" style="margin-top:6px">
        <div class="stat-card" id="formHomeCard">
          <div class="stat-title" id="formHomeTeam">Local: —</div>
          <div class="stat-values" id="formHomeBox">PJ: — | G: — | E: — | P: —</div>
        </div>
        <div class="stat-card" id="formAwayCard">
          <div class="stat-title" id="formAwayTeam">Visitante: —</div>
          <div class="stat-values" id="formAwayBox">PJ: — | G: — | E: — | P: —</div>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div class="card">
      <h3>Resultados & Recomendaciones</h3>
      <div class="kpis" style="margin-top:6px">
        <div class="tile"><strong id="pHome">—</strong><div class="small">Prob. Local</div></div>
        <div class="tile"><strong id="pDraw">—</strong><div class="small">Prob. Empate</div></div>
        <div class="tile"><strong id="pAway">—</strong><div class="small">Prob. Visitante</div></div>
        <div class="tile"><strong id="pBTTS">—</strong><div class="small">Prob. BTTS</div></div>
        <div class="tile"><strong id="pO25">—</strong><div class="small">Prob. Over 2.5</div></div>
        <div class="tile"><strong id="expectedBest">—</strong><div class="small">Mejor EV</div></div>
      </div>

      <div class="sep"></div>
      
      <h4>Factores Aplicados</h4>
      <div class="correction-factors">
        <div class="correction-factor">
          <div class="label">Ventaja Local</div>
          <div class="value" id="homeAdvantageFactor">1.00x</div>
        </div>
        <div class="correction-factor">
          <div class="label">Fuerza Relativa</div>
          <div class="value" id="strengthFactor">1.00x</div>
        </div>
        <div class="correction-factor">
          <div class="label">Forma Reciente</div>
          <div class="value" id="recentFormFactor">1.00x</div>
        </div>
        <div class="correction-factor">
          <div class="label">Dixon-Coles</div>
          <div class="value" id="dixonColesFactor">1.00x</div>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div id="details" class="recs small"></div>

      <div class="suggest" id="suggestion" style="display:none"></div>
      
      <div class="sep"></div>
      
      <div>
        <h4>Stake según Kelly</h4>
        <div class="table-like">
          <div class="stat-card">
            <div class="stat-title">Stake recomendado</div>
            <div class="stat-values" id="kellyStake">—%</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Monto a apostar</div>
            <div class="stat-values" id="kellyAmount">—</div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
/** Helper */
function parseForm(str){
  const m = str.match(/^(\d+)-(\d+)-(\d+)$/);
  return m ? {W:+m[1],D:+m[2],L:+m[3]} : {W:0,D:0,L:0};
}
function clamp01(x){return Math.max(0,Math.min(1,x));}
function calculateFormFactor(formH,formA,weight){
  const ratioH = (formH.W*3 + formH.D)/15; // max puntos 15
  const ratioA = (formA.W*3 + formA.D)/15;
  return 1 + (ratioH - ratioA) * weight/100;
}
function calculateStrengthFactor(posH,posA,maxTeams){
  // evita dividir por cero y asegura >=0.3
  const factor = (maxTeams-posH)/(maxTeams-posA+0.1);
  return Math.max(factor,0.3);
}
function dixonColesAdjustment(lambdaH,lambdaA,rho){
  // simple ajuste
  return 1 + rho*Math.exp(-lambdaH - lambdaA);
}

/** Poisson básico */
function poisson(k,lambda){return Math.pow(lambda,k)*Math.exp(-lambda)/factorial(k);}
function factorial(n){return n<=1?1:n*factorial(n-1);}

/** Main Compute */
function computeProbabilities(){
  const gfH=parseFloat(document.getElementById('gfHome').value)||0;
  const gaH=parseFloat(document.getElementById('gaHome').value)||0;
  const gfA=parseFloat(document.getElementById('gfAway').value)||0;
  const gaA=parseFloat(document.getElementById('gaAway').value)||0;
  const posH=parseInt(document.getElementById('posHome').value)||10;
  const posA=parseInt(document.getElementById('posAway').value)||10;
  const formH=parseForm(document.getElementById('formHome').value);
  const formA=parseForm(document.getElementById('formAway').value);
  const homeAdvantage=parseFloat(document.getElementById('homeAdvantage').value)/100||0.15;
  const formWeight=parseFloat(document.getElementById('formWeight').value)||30;
  const rho=parseFloat(document.getElementById('dixonColesParam').value)||-0.13;
  const maxTeams=parseInt(document.getElementById('maxTeams').value)||20;

  const lambdaHome = gfH;
  const lambdaAway = gfA;

  const strengthFactor = calculateStrengthFactor(posH,posA,maxTeams);
  const recentFormFactor = calculateFormFactor(formH,formA,formWeight);
  const homeAdvFactor = 1 + homeAdvantage;

  const adjHome = Math.max(lambdaHome * homeAdvFactor * strengthFactor * recentFormFactor,0.3);
  const adjAway = Math.max(lambdaAway / strengthFactor / recentFormFactor,0.3);

  const dcFactor = dixonColesAdjustment(adjHome,adjAway,rho);

  // Probabilidades
  let pHome=0,pDraw=0,pAway=0,pBTTS=0,pO25=0;
  const maxGoals=10;
  for(let h=0;h<=maxGoals;h++){
    for(let a=0;a<=maxGoals;a++){
      const prob=poisson(h,adjHome)*poisson(a,adjAway)*dcFactor;
      if(h>a) pHome+=prob;
      else if(h==a) pDraw+=prob;
      else pAway+=prob;
      if(h>0 && a>0) pBTTS+=prob;
      if(h+a>2) pO25+=prob;
    }
  }

  // clamp 0-1
  pHome=clamp01(pHome); pDraw=clamp01(pDraw); pAway=clamp01(pAway);
  pBTTS=clamp01(pBTTS); pO25=clamp01(pO25);

  // Mejor EV
  const oddsHome=parseFloat(document.getElementById('oddsHome').value);
  const oddsDraw=parseFloat(document.getElementById('oddsDraw').value);
  const oddsAway=parseFloat(document.getElementById('oddsAway').value);
  const oddsBTTS=parseFloat(document.getElementById('oddsBTTS').value);
  const oddsO25=parseFloat(document.getElementById('oddsOver25').value);
  const evHome=pHome*oddsHome-1;
  const evDraw=pDraw*oddsDraw-1;
  const evAway=pAway*oddsAway-1;
  const evBTTS=pBTTS*oddsBTTS-1;
  const evO25=pO25*oddsO25-1;

  const evs=[{label:'Local',ev:evHome},{label:'Empate',ev:evDraw},{label:'Visitante',ev:evAway},{label:'BTTS',ev:evBTTS},{label:'Over 2.5',ev:evO25}];
  evs.sort((a,b)=>b.ev-a.ev);
  const bestEV=evs[0];

  // Kelly stake
  const bankroll=parseFloat(document.getElementById('bankroll').value)||1000;
  const stake=Math.max(0,(bestEV.ev/( (bestEV.label==='Local'?oddsHome:
                                           bestEV.label==='Empate'?oddsDraw:
                                           bestEV.label==='Visitante'?oddsAway:
                                           bestEV.label==='BTTS'?oddsBTTS:oddsO25)-1) )*100);
  const amount=bankroll*stake/100;

  // Update UI
  document.getElementById('pHome').innerText=(pHome*100).toFixed(1)+'%';
  document.getElementById('pDraw').innerText=(pDraw*100).toFixed(1)+'%';
  document.getElementById('pAway').innerText=(pAway*100).toFixed(1)+'%';
  document.getElementById('pBTTS').innerText=(pBTTS*100).toFixed(1)+'%';
  document.getElementById('pO25').innerText=(pO25*100).toFixed(1)+'%';
  document.getElementById('expectedBest').innerText=bestEV.label;
  document.getElementById('kellyStake').innerText=stake.toFixed(1)+'%';
  document.getElementById('kellyAmount').innerText='Q '+amount.toFixed(2);

  // Factores
  document.getElementById('homeAdvantageFactor').innerText=homeAdvFactor.toFixed(2)+'x';
  document.getElementById('strengthFactor').innerText=strengthFactor.toFixed(2)+'x';
  document.getElementById('recentFormFactor').innerText=recentFormFactor.toFixed(2)+'x';
  document.getElementById('dixonColesFactor').innerText=dcFactor.toFixed(2)+'x';
}

/** Events */
document.getElementById('recalc').addEventListener('click',computeProbabilities);
document.getElementById('reset').addEventListener('click',()=>{
  document.querySelectorAll('input').forEach(i=>{i.value='';});
  document.querySelectorAll('select').forEach(s=>{s.selectedIndex=0;});
});
document.getElementById('clearAll').addEventListener('click',()=>{
  location.reload();
});
</script>
</body>
</html>
