<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada • Poisson + Kelly</title>
<style>
:root{--gap:12px;--radius:10px;--bg:#0f1220;--card:#191c2f;--muted:rgba(230,233,245,.75);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:24px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:var(--card);border:1px solid #2a2e4a;padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.08)}
label{font-size:13px;opacity:.95}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2e4a;background:var(--bg);color:inherit}
.row{display:flex;gap:10px}
.row > *{flex:1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}
.btn {padding:10px 16px;border-radius:12px;border:none;background:linear-gradient(135deg,#4f46e5,#6366f1);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s ease-in-out;box-shadow:0 4px 12px rgba(0,0,0,0.25);}
.btn:hover {transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.35);}
.btn:active {transform:translateY(1px);box-shadow:0 3px 10px rgba(0,0,0,0.25);}
#saveBank {background:linear-gradient(135deg,#ef4444,#f87171);}
#clearAll {background:linear-gradient(135deg,#ef6f6f,#fb8b8b);}
.sep{height:1px;background:#2a2e4a;margin:10px 0}
.recs{display:grid;gap:8px}
.bad{color:#f87171}.good{color:#6ee7a1}.neutral{color:#93c5fd}
.table-like{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Calculadora Apuestas Avanzada • Poisson + Kelly</h1>
    <p class="small">Introduce estadísticas por equipo (pos., GF/GC local/visitante, forma). La herramienta recomienda mercados y stake según EV + Kelly.</p>
  </div>

  <div class="grid">
    <!-- Card: Equipos y estadísticas -->
    <div class="card">
      <h3>Equipos y estadísticas</h3>
      <div class="table-like">
        <div>
          <label>Liga</label>
          <select id="leagueSelect">
            <option value="">-- Selecciona liga --</option>
          </select>
        </div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div>
          <label>Equipo Local</label>
          <select id="teamHome"></select>
        </div>
        <div>
          <label>Equipo Visitante</label>
          <select id="teamAway"></select>
        </div>
      </div>

      <div class="sep"></div>
      <h4>Posición en la tabla</h4>
      <div class="table-like">
        <div><label>Pos Local (1 = mejor)</label><input id="posHome" type="number" min="1" step="1"/></div>
        <div><label>Pos Visitante</label><input id="posAway" type="number" min="1" step="1"/></div>
      </div>

      <div class="sep"></div>
      <h4>Promedios (por partido)</h4>
      <div class="table-like">
        <div><label>GF local</label><input id="gfHome" type="number" step="0.01" min="0"/></div>
        <div><label>GC local</label><input id="gaHome" type="number" step="0.01" min="0"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>GF visitante</label><input id="gfAway" type="number" step="0.01" min="0"/></div>
        <div><label>GC visitante</label><input id="gaAway" type="number" step="0.01" min="0"/></div>
      </div>

      <div class="sep"></div>
      <h4>Forma (últimos 5)</h4>
      <div class="table-like">
        <div><label>Victorias últimas 5 (Local)</label><input id="formHome" type="number" min="0" max="5" step="1"/></div>
        <div><label>Victorias últimas 5 (Visitante)</label><input id="formAway" type="number" min="0" max="5" step="1"/></div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
let teamsByLeague = {};
let dataByLeague = {};

// Cargar datos desde WebApp
async function cargarDatos() {
  const url = "https://script.google.com/macros/s/TU_WEBAPP_ID/exec"; // reemplaza TU_WEBAPP_ID
  try {
    const resp = await fetch(url);
    dataByLeague = await resp.json();
    teamsByLeague = {};
    Object.keys(dataByLeague).forEach(codigo => {
      teamsByLeague[codigo] = dataByLeague[codigo].map(t => t.name);
    });
    // llenar select de ligas
    const leagueSelect = $('leagueSelect');
    Object.keys(teamsByLeague).forEach(codigo => {
      const opt = document.createElement('option');
      opt.value = codigo;
      opt.textContent = codigo; // puedes poner nombre completo si quieres
      leagueSelect.appendChild(opt);
    });
  } catch(e) {
    console.error("Error cargando datos:", e);
  }
}

// Llenar equipos y auto-completar stats
function actualizarEquipos() {
  const l = $('leagueSelect').value;
  const teamHome = $('teamHome');
  const teamAway = $('teamAway');
  teamHome.innerHTML = '<option value="">-- Selecciona equipo --</option>';
  teamAway.innerHTML = '<option value="">-- Selecciona equipo --</option>';
  if (!l || !teamsByLeague[l]) return;
  teamsByLeague[l].forEach(t => {
    const opt1 = document.createElement('option'); opt1.value = t; opt1.textContent = t; teamHome.appendChild(opt1);
    const opt2 = document.createElement('option'); opt2.value = t; opt2.textContent = t; teamAway.appendChild(opt2);
  });
}

// Llenar stats al seleccionar equipo
function completarStats(equipo, esLocal=true) {
  const liga = $('leagueSelect').value;
  if (!liga || !dataByLeague[liga]) return;
  const datos = dataByLeague[liga].find(t => t.name === equipo);
  if (!datos) return;
  if (esLocal) {
    $('posHome').value = datos.pos;
    $('gfHome').value = datos.gf;
    $('gaHome').value = datos.ga;
    $('formHome').value = datos.form || 0;
  } else {
    $('posAway').value = datos.pos;
    $('gfAway').value = datos.gf;
    $('gaAway').value = datos.ga;
    $('formAway').value = datos.form || 0;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  await cargarDatos();
  $('leagueSelect').addEventListener('change', actualizarEquipos);
  $('teamHome').addEventListener('change', e => completarStats(e.target.value, true));
  $('teamAway').addEventListener('change', e => completarStats(e.target.value, false));
});
</script>
</body>
</html>
