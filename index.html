<script>
const $ = id => document.getElementById(id);
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
const formatPct = x => (100 * x).toFixed(1) + '%';
const formatMoney = x => 'Q ' + x.toFixed(2);
const MAX_GOALS_DEFAULT = 8;
function toDecimalOdds(v){ const a=parseFloat(v); return isNaN(a)||a<=0?1.01:a; }

// --- Poisson ---
const factCache = [0,0];
function logFactorial(n){ if(n<2) return 0; if(factCache[n]) return factCache[n]; let s=0; for(let i=2;i<=n;i++) s+=Math.log(i); factCache[n]=s; return s; }
function poissonPMF(k,lambda){ return lambda<=0 ? (k===0?1:0) : Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k)); }

// --- Lambdas ---
function computeLambdas({gfHome, gaHome, gfAway, gaAway, leagueAvg, posHome, posAway, formHome, formAway}){
  const h_adv = clamp(gfHome/leagueAvg,0.5,1.4);
  let lambdaHome = Math.max(0,(gfHome*gaAway/leagueAvg)*h_adv);
  let lambdaAway = Math.max(0,(gfAway*gaHome/leagueAvg));
  const posFactor = clamp(1 + ((posAway - posHome)/40),0.9,1.12);
  lambdaHome *= posFactor; lambdaAway /= posFactor;
  lambdaHome *= clamp(1 + ((formHome-2.5)/25),0.85,1.12);
  lambdaAway *= clamp(1 + ((formAway-2.5)/25),0.85,1.12);
  return {lambdaHome: clamp(lambdaHome,0,6), lambdaAway: clamp(lambdaAway,0,6), h_adv, posFactor};
}

// --- 1X2 ---
function compute1X2(lambdaHome, lambdaAway, maxGoals){
  const pHomeGoals=[], pAwayGoals=[];
  for(let i=0;i<=maxGoals;i++){pHomeGoals[i]=poissonPMF(i,lambdaHome); pAwayGoals[i]=poissonPMF(i,lambdaAway);}
  const tailHome = 1 - pHomeGoals.reduce((a,b)=>a+b,0);
  const tailAway = 1 - pAwayGoals.reduce((a,b)=>a+b,0);
  pHomeGoals[maxGoals]+=tailHome; pAwayGoals[maxGoals]+=tailAway;
  let pHomeWin=0,pDraw=0,pAwayWin=0;
  for(let i=0;i<=maxGoals;i++)for(let j=0;j<=maxGoals;j++){
    const p=pHomeGoals[i]*pAwayGoals[j];
    if(i>j)pHomeWin+=p;
    else if(i===j)pDraw+=p;
    else pAwayWin+=p;
  }
  const total=pHomeWin+pDraw+pAwayWin;
  return {pHomeWin:pHomeWin/total,pDraw:pDraw/total,pAwayWin:pAwayWin/total};
}

// --- BTTS & Over2.5 ---
function computeBTTS(lambdaHome, lambdaAway){
  const pNoHome=Math.exp(-lambdaHome);
  const pNoAway=Math.exp(-lambdaAway);
  const pBTTS=1 - pNoHome - pNoAway + pNoHome*pNoAway;
  const lT=lambdaHome+lambdaAway;
  const pOver25=1-(poissonPMF(0,lT)+poissonPMF(1,lT)+poissonPMF(2,lT));
  return {pBTTS,pOver25};
}

// --- EV & Kelly ---
function expectedValue(p,odds){ return p*(odds-1)-(1-p); }
function kellyFraction(p,odds){ const b=odds-1; const q=1-p; const f=(b*p-q)/b; return clamp(f,0,1); }

// --- Storage banca ---
function getBankrollFromStorage(){
  try{
    const saved=JSON.parse(localStorage.getItem('calc_bankroll_v1')||'null');
    if(!saved) return null;
    const now=new Date();
    if(saved.month!==now.getMonth()||saved.year!==now.getFullYear()) return null;
    return saved.value;
  }catch(e){return null;}
}
function saveBankrollToStorage(value){
  try{
    const now=new Date();
    localStorage.setItem('calc_bankroll_v1', JSON.stringify({value:Number(value),month:now.getMonth(),year:now.getFullYear()}));
  }catch(e){}
}

// --- Inputs ---
function gatherInputs(){
  return {
    teamHome:$('teamHome').value||'Local',
    teamAway:$('teamAway').value||'Visitante',
    posHome:Number($('posHome').value)||10,
    posAway:Number($('posAway').value)||10,
    gfHome:Number($('gfHome').value)||1.0,
    gaHome:Number($('gaHome').value)||1.0,
    gfAway:Number($('gfAway').value)||1.0,
    gaAway:Number($('gaAway').value)||1.0,
    formHome:Number($('formHome').value)||2,
    formAway:Number($('formAway').value)||2,
    leagueAvg:Number($('leagueAvg').value)||1.35,
    maxGoals:Math.max(4,Number($('maxGoals').value)||MAX_GOALS_DEFAULT),
    oddsHome:toDecimalOdds($('oddsHome').value),
    oddsDraw:toDecimalOdds($('oddsDraw').value),
    oddsAway:toDecimalOdds($('oddsAway').value),
    oddsBTTS:toDecimalOdds($('oddsBTTS').value),
    oddsOver25:toDecimalOdds($('oddsOver25').value),
    bankroll:Number($('bankroll').value)||0
  };
}

// --- Render ---
function renderRecommendations(result){
  const details=$('details'); details.innerHTML='';
  const info=document.createElement('div'); info.className='small';
  info.innerHTML=`<strong>Lambdas:</strong> λA=${result.lambdaHome.toFixed(2)} λB=${result.lambdaAway.toFixed(2)}<br/>
  <strong>Ventaja casa (h):</strong> ${result.h_adv.toFixed(2)} • <strong>posFactor:</strong> ${result.posFactor.toFixed(3)}`;
  details.appendChild(info);

  const markets=result.markets.slice().sort((a,b)=>b.ev-a.ev);
  markets.forEach(m=>{
    const el=document.createElement('div');
    el.style.padding='8px'; el.style.border='1px solid #2a2e4a'; el.style.borderRadius='8px'; el.style.marginBottom='6px';
    el.innerHTML=`<strong>${m.name}</strong> — Prob: ${formatPct(m.p)} • Cuota: ${m.odds.toFixed(2)} • EV: ${(m.ev>=0?'+':'')+m.ev.toFixed(3)} • Kelly: ${(m.kelly*100).toFixed(2)}% • Stake: ${formatMoney(m.stake)} ${m.ev>0?'<span class="good">▶ sugerido</span>':''}`;
    details.appendChild(el);
  });

  const best=markets.find(m=>m.ev>0);
  $('expectedBest').textContent=best?best.name:'Ninguno (EV negativo)';
}

// --- Run calc ---
function runCalculation(){
  const inps=gatherInputs();
  const lamb=computeLambdas(inps);
  const mx=compute1X2(lamb.lambdaHome,lamb.lambdaAway,inps.maxGoals);
  const {pBTTS,pOver25}=computeBTTS(lamb.lambdaHome,lamb.lambdaAway);

  $('pHome').textContent=formatPct(mx.pHomeWin);
  $('pDraw').textContent=formatPct(mx.pDraw);
  $('pAway').textContent=formatPct(mx.pAwayWin);
  $('pBTTS').textContent=formatPct(pBTTS);
  $('pO25').textContent=formatPct(pOver25);

  const bank=inps.bankroll||0;
  const markets=[];
  function pushMarket(name,p,odds){
    const ev=expectedValue(p,odds);
    const k=kellyFraction(p,odds);
    const stake=bank*k*0.5;
    markets.push({name,p,odds,ev,kelly:k,stake});
  }
  pushMarket(`1 (Local)`,mx.pHomeWin,inps.oddsHome);
  pushMarket(`X (Empate)`,mx.pDraw,inps.oddsDraw);
  pushMarket(`2 (Visitante)`,mx.pAwayWin,inps.oddsAway);
  pushMarket(`BTTS Sí`,pBTTS,inps.oddsBTTS);
  pushMarket(`Over 2.5`,pOver25,inps.oddsOver25);

  renderRecommendations({...lamb,markets});
}

// --- Events ---
const allInputs=document.querySelectorAll('input');
allInputs.forEach(i=>i.addEventListener('input',runCalculation));
$('reset').addEventListener('click',()=>{
  $('posHome').value=5; $('posAway').value=12;
  $('gfHome').value=1.6; $('gaHome').value=1.1;
  $('gfAway').value=1.4; $('gaAway').value=1.2;
  $('formHome').value=3; $('formAway').value=1;
  $('oddsHome').value=2.10; $('oddsDraw').value=3.40; $('oddsAway').value=3.80;
  $('oddsBTTS').value=1.90; $('oddsOver25').value=2.00;
  runCalculation();
});
$('saveBank').addEventListener('click',()=>{
  const val=Number($('bankroll').value)||0;
  saveBankrollToStorage(val);
  alert('Banca guardada para este mes: Q '+val.toFixed(2));
});
window.addEventListener('load',()=>{
  const saved=getBankrollFromStorage();
  if(saved!==null) $('bankroll').value=saved;
  runCalculation();
});
</script>
