<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada • Poisson + Mejoras</title>
<style>
/* --- estilo igual que tu versión original --- */
:root{--gap:12px;--radius:10px;--bg:#0f1220;--card:#191c2f;--muted:rgba(230,233,245,.75);--accent:#4f46e5;--accent-2:#6ee7a1;--accent-3:#f59e0b}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:8px}.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.card{background:var(--card);border:1px solid #2a2e4a;padding:12px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.28)}
label{font-size:13px;opacity:.95}input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2e4a;background:transparent;color:inherit}
.row{display:flex;gap:10px}.row>*{flex:1}.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}.btn{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),#6366f1);color:#fff;font-weight:700;cursor:pointer;transition:all .14s ease}
.btn:hover{transform:translateY(-2px)}.btn-secondary{background:linear-gradient(135deg,var(--accent-3),#f59e0b);}
.sep{height:1px;background:#2a2e4a;margin:10px 0}.recs{display:grid;gap:8px}.table-like{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:6px}
.stat-title{font-size:12px;color:var(--muted);font-weight:600}.stat-values{font-size:15px;font-weight:700}.suggest{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(90deg,#062b14, rgba(110,231,161,0.06));border-left:4px solid var(--accent-2);font-weight:700}
.abbrev{font-size:12px;color:var(--muted);margin-top:8px}.correction-factors{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}.correction-factor{background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; text-align:center;}
.correction-factor .label{font-size:12px;color:var(--muted)}.correction-factor .value{font-size:14px;font-weight:bold}
@media(max-width:880px){.grid{grid-template-columns:1fr}.table-like{grid-template-columns:1fr}.correction-factors{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<!-- --- Todo tu HTML de formulario y resultados igual que antes --- -->
<!-- Tu código HTML permanece intacto, tal como lo enviaste, incluyendo inputs, select y tarjetas de resultados -->
</div>

<script>
const $ = id => document.getElementById(id);
const formatPct = x => (100 * (isFinite(x)?x:0)).toFixed(1)+'%';
const formatDec = x => (isFinite(x)?x.toFixed(2):'0.00');
function parseNumberString(val){ const s=String(val||'').toString().replace(/,/g,'.'); const n=Number(s); return isFinite(n)?n:0; }
function toDecimalOdds(v){ const a=parseFloat(String(v).replace(/,/g,'.')); return isNaN(a)||a<=0?1.01:a; }

const WEBAPP_URL="https://script.google.com/macros/s/AKfycbyP6dc9ww4I9kw26fQCc0gAyEtYbQVg6DsoAtlnxqhFFJClOrHoudM8PdnBnT9YBopSlA/exec";
let teamsByLeague={};
const leagueNames={"WC":"FIFA World Cup","CL":"UEFA Champions League","BL1":"Bundesliga","DED":"Eredivisie","BSA":"Campeonato Brasileiro","PD":"Liga Española","FL1":"Ligue 1","ELC":"Championship","PPL":"Primeira Liga","EC":"European Championship","SA":"Serie A","PL":"Premier League"};

function normalizeTeam(raw){ if(!raw)return null; const r={};
r.name=raw.name||raw.Team||raw.team?.name||raw.teamName||raw.team_name||raw['Equipo']||raw['team']||raw['team_name']||raw['team.shortName']||'';
r.pos=raw.pos||raw.position||raw.rank||raw['Pos']||raw['POS']||null;
r.gf=parseNumberString(raw.gf||raw.goalsFor||raw.goals_for||raw.GF||raw['GF']||raw['goals']||raw['goals_for']);
r.ga=parseNumberString(raw.ga||raw.goalsAgainst||raw.goals_against||raw.GC||raw['GC']||  raw['goals_against']);
r.pj=parseNumberString(raw.PJ||raw.pj||raw.played||raw.playedGames||raw.matches||raw['Matches']||raw['matches']);
r.g=parseNumberString(raw.G||raw.g||raw.won||raw.W||raw.w);
r.e=parseNumberString(raw.E||raw.e||raw.draw||raw.D||raw.draws||raw.drawn);
r.p=parseNumberString(raw.P||raw.p||raw.lost||raw.L||raw.l);
r.form=raw.form||raw.Form||null;
return r;}

async function fetchTeams(){
  try{
    const res = await fetch(WEBAPP_URL);
    if(!res.ok)throw new Error('fetch falló '+res.status);
    const data = await res.json();
    const normalized={};
    for(const key in data){const arr=data[key]||[]; normalized[key]=arr.map(x=>normalizeTeam(x));}
    return normalized;
  }catch(err){console.error('Error fetching teams:',err); return {};}
}

async function init(){
  teamsByLeague = await fetchTeams();
  Object.keys(teamsByLeague).forEach(code=>{const opt=document.createElement('option'); opt.value=code; opt.textContent=leagueNames[code]||code; $('leagueSelect').appendChild(opt);});
  const saved=localStorage.getItem('bankroll'); if(saved)$('bankroll').value=saved;
  $('leagueSelect').addEventListener('change', onLeagueChange);
  $('teamHome').addEventListener('change', ()=>fillTeamData($('teamHome').value,$('leagueSelect').value,'Home'));
  $('teamAway').addEventListener('change', ()=>fillTeamData($('teamAway').value,$('leagueSelect').value,'Away'));
  $('recalc').addEventListener('click', calculateAll);
  $('reset').addEventListener('click', ()=>location.reload());
  $('clearAll').addEventListener('click', clearAll);
  $('saveBank').addEventListener('click', saveBankrollToStorage);
  $('homeAdvantage').addEventListener('change', calculateAll);
  $('formWeight').addEventListener('change', calculateAll);
  $('dixonColesParam').addEventListener('change', calculateAll);
  $('maxTeams').addEventListener('change', calculateAll);
  $('formHome').addEventListener('change', calculateAll);
  $('formAway').addEventListener('change', calculateAll);
}
document.addEventListener('DOMContentLoaded', init);

/* --- Funciones matemáticas y de Poisson, Dixon-Coles, forma, fuerza relativa --- */
/* Tu código de factorial, poissonPMF, clamp01, dixonColesAdjustment, calculateStrengthFactor, calculateFormFactor se mantiene igual pero con ajuste de límites y normalización entre 0.3 y 1.5 */

function computeProbabilities(lambdaHome, lambdaAway){
  const homeAdvantageFactor = 1 + (parseNumberString($('homeAdvantage').value)/100);
  const posHome=parseNumberString($('posHome').value);
  const posAway=parseNumberString($('posAway').value);
  const maxTeams=parseNumberString($('maxTeams').value);
  const strengthFactor = Math.min(Math.max(calculateStrengthFactor(posHome,posAway,maxTeams),0.3),1.5);
  
  const formHome = $('formHome').value;
  const formAway = $('formAway').value;
  const formWeight=parseNumberString($('formWeight').value);
  const recentFormFactor = Math.min(Math.max(calculateFormFactor(formHome,formAway,formWeight),0.3),1.5);
  
  const rho=parseNumberString($('dixonColesParam').value);
  const dixonColesFactor=dixonColesAdjustment(lambdaHome,lambdaAway,rho);

  $('homeAdvantageFactor').textContent=formatDec(homeAdvantageFactor)+'x';
  $('strengthFactor').textContent=formatDec(strengthFactor)+'x';
  $('recentFormFactor').textContent=formatDec(recentFormFactor)+'x';
  $('dixonColesFactor').textContent=formatDec(dixonColesFactor)+'x';
  
  const adjHome=Math.max(lambdaHome*homeAdvantageFactor*strengthFactor*recentFormFactor,0.3);
  const adjAway=Math.max(lambdaAway/strengthFactor/recentFormFactor,0.3);
  
  let pHome=0,pDraw=0,pAway=0; const maxGoals=8;
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const prob=poissonPMF(adjHome,i)*poissonPMF(adjAway,j)*dixonColesFactor;
      if(i>j)pHome+=prob; else if(i===j)pDraw+=prob; else pAway+=prob;
    }
  }
  const total=pHome+pDraw+pAway; if(total>0){pHome/=total;pDraw/=total;pAway/=total;}
  
  let pBTTS=0; let pO25=0;
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const prob=poissonPMF(adjHome,i)*poissonPMF(adjAway,j)*dixonColesFactor;
      if(i>0 && j>0)pBTTS+=prob;
      if(i+j>2.5)pO25+=prob;
    }
  }
  return {pHome:clamp01(pHome),pDraw:clamp01(pDraw),pAway:clamp01(pAway),pBTTS:clamp01(pBTTS),pO25:clamp01(pO25)};
}

/* --- Resto del código: calculateKellyStake, suggestBet, calculateAll, fillTeamData, clearAll --- */
/* Se mantienen igual, solo se aplican los factores mejorados y normalizados */

</script>
</body>
</html>
