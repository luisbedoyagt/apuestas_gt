<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada • Poisson + Kelly</title>
<style>
:root{--gap:12px;--radius:10px;--bg:#0f1220;--card:#191c2f;--muted:rgba(230,233,245,.75);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:24px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:var(--card);border:1px solid #2a2e4a;padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.08)}
label{font-size:13px;opacity:.95}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2e4a;background:var(--bg);color:inherit}
.row{display:flex;gap:10px}
.row > *{flex:1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}
.btn{padding:8px 10px;border-radius:8px;border:1px solid #2a2e4a;background:var(--bg);cursor:pointer}
.sep{height:1px;background:#2a2e4a;margin:10px 0}
.recs{display:grid;gap:8px}
.bad{color:#f87171}.good{color:#6ee7a1}.neutral{color:#93c5fd}
.table-like{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Calculadora Apuestas Avanzada • Poisson + Kelly</h1>
    <p class="small">Introduce estadísticas por equipo (pos., GF/GC local/visitante, forma). La herramienta recomienda mercados y stake según EV + Kelly.</p>
  </div>

  <!-- BANCA -->
  <div class="grid">
    <div class="card">
      <h3>Banco mensual</h3>
      <div class="table-like">
        <div>
          <label>Banca actual (Q)</label>
          <input id="bankroll" type="number" value="1000" min="0" step="1"/>
        </div>
        <div>
          <label>Guarda / Actualiza</label><br/>
          <button id="saveBank" class="btn">Guardar banca</button>
        </div>
      </div>
      <p class="small">La banca se guarda en tu navegador y se resetea si cambia el mes.</p>
      <div class="sep"></div>

      <h3>Parámetros globales</h3>
      <div class="table-like">
        <div>
          <label>Media liga (goles / partido por equipo)</label>
          <input id="leagueAvg" type="number" value="1.35" step="0.01" min="0.01"/>
        </div>
        <div>
          <label>Máx goles a calcular (Poisson)</label>
          <input id="maxGoals" type="number" value="8" min="4" step="1"/>
        </div>
      </div>
    </div>

    <!-- EQUIPOS -->
    <div class="card">
      <h3>Equipos y estadísticas</h3>
      <div class="table-like">
        <div><label>Equipo Local</label><input id="teamHome" type="text" placeholder="Local"/></div>
        <div><label>Equipo Visitante</label><input id="teamAway" type="text" placeholder="Visitante"/></div>
      </div>

      <div class="sep"></div>
      <h4>Posición en la tabla</h4>
      <div class="table-like">
        <div><label>Pos Local</label><input id="posHome" type="number" value="5"/></div>
        <div><label>Pos Visitante</label><input id="posAway" type="number" value="12"/></div>
      </div>

      <div class="sep"></div>
      <h4>Promedios</h4>
      <div class="table-like">
        <div><label>GF local</label><input id="gfHome" type="number" value="1.6" step="0.01"/></div>
        <div><label>GC local</label><input id="gaHome" type="number" value="1.1" step="0.01"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>GF visitante</label><input id="gfAway" type="number" value="1.4" step="0.01"/></div>
        <div><label>GC visitante</label><input id="gaAway" type="number" value="1.2" step="0.01"/></div>
      </div>

      <div class="sep"></div>
      <h4>Forma & % BTTS</h4>
      <div class="table-like">
        <div><label>Victorias últimas 5 (Local)</label><input id="formHome" type="number" value="3"/></div>
        <div><label>Victorias últimas 5 (Away)</label><input id="formAway" type="number" value="1"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>% BTTS local</label><input id="bttsHomePct" type="number" value="60"/></div>
        <div><label>% BTTS away</label><input id="bttsAwayPct" type="number" value="55"/></div>
      </div>
    </div>
  </div>

  <!-- ODDS Y RESULTADOS -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>Cuotas</h3>
      <div class="table-like">
        <div><label>Local</label><input id="oddsHome" type="number" value="2.10"/></div>
        <div><label>Empate</label><input id="oddsDraw" type="number" value="3.40"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>Visitante</label><input id="oddsAway" type="number" value="3.80"/></div>
        <div><label>BTTS Sí</label><input id="oddsBTTS" type="number" value="1.90"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>Over 2.5</label><input id="oddsOver25" type="number" value="2.00"/></div>
        <div></div>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="recalc" class="btn">Calcular</button>
        <button id="reset" class="btn">Reset</button>
      </div>
    </div>

    <div class="card">
      <h3>Resultados & Recomendaciones</h3>
      <div class="kpis">
        <div class="tile"><strong id="pHome">—</strong><div class="small">Prob. Local</div></div>
        <div class="tile"><strong id="pDraw">—</strong><div class="small">Prob. Empate</div></div>
        <div class="tile"><strong id="pAway">—</strong><div class="small">Prob. Visitante</div></div>
        <div class="tile"><strong id="pBTTS">—</strong><div class="small">Prob. BTTS</div></div>
        <div class="tile"><strong id="pO25">—</strong><div class="small">Prob. Over 2.5</div></div>
        <div class="tile"><strong id="expectedBest">—</strong><div class="small">Mejor EV</div></div>
      </div>

      <div class="sep"></div>
      <div id="details" class="recs small"></div>
    </div>
  </div>
</div>

<script>
// helpers
const $=id=>document.getElementById(id);
const formatPct=x=>(100*x).toFixed(1)+'%';
const formatMoney=x=>'Q '+x.toFixed(2);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

// Poisson
function poissonPMF(k,lambda){
  return (Math.pow(lambda,k)*Math.exp(-lambda))/factorial(k);
}
function factorial(n){return n? n*factorial(n-1):1;}

// Compute lambdas
function computeLambdas({gfHome,gaHome,gfAway,gaAway,leagueAvg,posHome,posAway,formHome,formAway}){
  const h_adv=clamp(gfHome/leagueAvg,0.5,1.4);
  let lambdaHome=(gfHome*gaAway/leagueAvg)*h_adv;
  let lambdaAway=(gfAway*gaHome/leagueAvg);
  const posDiff=posAway-posHome;
  const posFactor=clamp(1+(posDiff/40),0.9,1.12);
  lambdaHome*=posFactor; lambdaAway/=posFactor;
  const formHomeF=1+((formHome-2.5)/25);
  const formAwayF=1+((formAway-2.5)/25);
  lambdaHome*=clamp(formHomeF,0.85,1.12);
  lambdaAway*=clamp(formAwayF,0.85,1.12);
  return {lambdaHome,lambdaAway,h_adv,posFactor};
}

// 1X2
function compute1X2(lH,lA,maxG){
  let pH=0,pD=0,pA=0;
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const p=poissonPMF(i,lH)*poissonPMF(j,lA);
      if(i>j)pH+=p; else if(i===j)pD+=p; else pA+=p;
    }
  }
  const total=pH+pD+pA;
  return {pHome:pH/total,pDraw:pD/total,pAway:pA/total};
}

// BTTS + Over 2.5
function computeBTTS(lH,lA,bttsHomePct,bttsAwayPct){
  const poissonBTTS=1-Math.exp(-lH)-Math.exp(-lA)+Math.exp(-(lH+lA));
  const histBTTS=(bttsHomePct+bttsAwayPct)/200;
  const pBTTS=(0.6*poissonBTTS+0.4*histBTTS);
  const lT=lH+lA;
  const pO25=1-(poissonPMF(0,lT)+poissonPMF(1,lT)+poissonPMF(2,lT));
  return {pBTTS,pO25};
}

// EV & Kelly
function expectedValue(p,odds){return p*(odds-1)-(1-p);}
function kelly(p,odds){const b=odds-1,q=1-p;return b<=0?0:clamp((b*p-q)/b,0,1);}

// main
function runCalculation(){
  const inps={
    gfHome:+$('gfHome').value,gaHome:+$('gaHome').value,
    gfAway:+$('gfAway').value,gaAway:+$('gaAway').value,
    posHome:+$('posHome').value,posAway:+$('posAway').value,
    formHome:+$('formHome').value,formAway:+$('formAway').value,
    bttsHomePct:+$('bttsHomePct').value,bttsAwayPct:+$('bttsAwayPct').value,
    leagueAvg:+$('leagueAvg').value,maxGoals:+$('maxGoals').value,
    oddsHome:+$('oddsHome').value,oddsDraw:+$('oddsDraw').value,
    oddsAway:+$('oddsAway').value,oddsBTTS:+$('oddsBTTS').value,
    oddsOver25:+$('oddsOver25').value,bankroll:+$('bankroll').value
  };

  const {lambdaHome,lambdaAway}=computeLambdas(inps);
  const {pHome,pDraw,pAway}=compute1X2(lambdaHome,lambdaAway,inps.maxGoals);
  const {pBTTS,pO25}=computeBTTS(lambdaHome,lambdaAway,inps.bttsHomePct,inps.bttsAwayPct);

  $('pHome').textContent=formatPct(pHome);
  $('pDraw').textContent=formatPct(pDraw);
  $('pAway').textContent=formatPct(pAway);
  $('pBTTS').textContent=formatPct(pBTTS);
  $('pO25').textContent=formatPct(pO25);

  const mkts=[];
  function add(name,p,odds){
    const ev=expectedValue(p,odds);
    const k=kelly(p,odds);
    const stake=inps.bankroll*k*0.5;
    mkts.push({name,p,odds,ev,k,stake});
  }
  add("1 (Local)",pHome,inps.oddsHome);
  add("X (Empate)",pDraw,inps.oddsDraw);
  add("2 (Visitante)",pAway,inps.oddsAway);
  add("BTTS Sí",pBTTS,inps.oddsBTTS);
  add("Over 2.5",pO25,inps.oddsOver25);

  const details=$('details');
  details.innerHTML='';
  mkts.sort((a,b)=>b.ev-a.ev).forEach(m=>{
    const div=document.createElement('div');
    div.innerHTML=`<strong>${m.name}</strong> → Prob: ${formatPct(m.p)} | Cuota: ${m.odds.toFixed(2)} | EV: ${(m.ev>=0?'+':'')+m.ev.toFixed(3)} | Kelly ${(m.k*100).toFixed(1)}% | Stake ${formatMoney(m.stake)} ${m.ev>0?'<span class="good">✔</span>':'<span class="bad">✖</span>'}`;
    details.appendChild(div);
  });

  const best=mkts.find(m=>m.ev>0);
  $('expectedBest').textContent=best?best.name:"Ninguno";
}

$('recalc').onclick=runCalculation;
$('reset').onclick=()=>{location.reload();}
window.onload=runCalculation;
</script>
</body>
</html>
