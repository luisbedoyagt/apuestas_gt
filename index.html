<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada â€¢ Poisson + Kelly</title>
<style>
:root{
  --gap:12px;
  --radius:12px;
  --bg:#0f1220;
  --card:#191c2f;
  --muted:rgba(230,233,245,.75);
  --btn-blue:linear-gradient(135deg,#3b82f6,#2563eb);
  --btn-red:linear-gradient(135deg,#ef4444,#f87171);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:24px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:var(--card);border:1px solid #2a2e4a;padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.08)}
label{font-size:13px;opacity:.95}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2e4a;background:var(--bg);color:inherit}
.row{display:flex;gap:10px}
.row > *{flex:1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}
.btn {
  padding:10px 16px;
  border-radius:14px;
  border:none;
  background:var(--btn-blue);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease-in-out;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
  display:flex; justify-content:center; align-items:center; gap:6px;
  position:relative;
  overflow:hidden;
}
.btn::after {
  content:"";
  position:absolute;
  top:0; left:-100%;
  width:100%;
  height:100%;
  background:rgba(255,255,255,0.15);
  transform:skewX(-20deg);
  transition:all 0.5s ease;
}
.btn:hover::after {left:200%;}
.btn:hover {transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.35);}
.btn:active {transform: translateY(1px); box-shadow:0 3px 10px rgba(0,0,0,0.25);}
#saveBank {
  background: var(--btn-red);
}
.sep{height:1px;background:#2a2e4a;margin:10px 0}
.recs{display:grid;gap:8px}
.bad{color:#f87171}.good{color:#6ee7a1}.neutral{color:#93c5fd}
.table-like{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Calculadora Apuestas Avanzada â€¢ Poisson + Kelly</h1>
    <p class="small">Introduce estadÃ­sticas por equipo (pos., GF/GC local/visitante, forma). La herramienta recomienda mercados y stake segÃºn EV + Kelly.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Banco mensual</h3>
      <div class="table-like">
        <div>
          <label>Banca actual (Q)</label>
          <input id="bankroll" type="number" value="1000" min="0" step="1"/>
        </div>
        <div>
          <label>Guarda / Actualiza</label><br/>
          <button id="saveBank" class="btn">ðŸ’¾ Guardar banca</button>
        </div>
      </div>
      <p class="small">La banca se guarda en tu navegador y se resetea si cambia el mes.</p>
      <div class="sep"></div>

      <h3>ParÃ¡metros globales</h3>
      <div class="table-like">
        <div>
          <label>Media liga (goles / partido por equipo)</label>
          <input id="leagueAvg" type="number" value="1.35" step="0.01" min="0.01"/>
        </div>
        <div>
          <label>MÃ¡x goles a calcular (Poisson)</label>
          <input id="maxGoals" type="number" value="8" min="4" step="1"/>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Equipos y estadÃ­sticas</h3>
      <div class="table-like">
        <div>
          <label>Liga</label>
          <select id="leagueSelect">
            <option value="">-- Selecciona liga --</option>
            <option value="ligaMX">Liga MX</option>
            <option value="MLS">MLS</option>
            <option value="LaLiga">Liga EspaÃ±ola</option>
            <option value="SerieA">Liga Italiana</option>
            <option value="PL">Liga Inglesa</option>
            <option value="Ligue1">Liga Francesa</option>
            <option value="Bundesliga">Liga Alemana</option>
            <option value="Guatemala">Liga Guatemalteca</option>
          </select>
        </div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div>
          <label>Equipo Local</label>
          <select id="teamHome"></select>
        </div>
        <div>
          <label>Equipo Visitante</label>
          <select id="teamAway"></select>
        </div>
      </div>

      <div class="sep"></div>
      <h4>PosiciÃ³n en la tabla</h4>
      <div class="table-like">
        <div><label>Pos Local (1 = mejor)</label><input id="posHome" type="number" value="5" min="1" step="1"/></div>
        <div><label>Pos Visitante</label><input id="posAway" type="number" value="12" min="1" step="1"/></div>
      </div>

      <div class="sep"></div>
      <h4>Promedios (por partido)</h4>
      <div class="table-like">
        <div><label>GF local</label><input id="gfHome" type="number" value="1.6" step="0.01"/></div>
        <div><label>GC local</label><input id="gaHome" type="number" value="1.1" step="0.01"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>GF visitante</label><input id="gfAway" type="number" value="1.4" step="0.01"/></div>
        <div><label>GC visitante</label><input id="gaAway" type="number" value="1.2" step="0.01"/></div>
      </div>

      <div class="sep"></div>
      <h4>Forma (Ãºltimos 5)</h4>
      <div class="table-like">
        <div><label>Victorias Ãºltimas 5 (Local)</label><input id="formHome" type="number" value="3" min="0" max="5" step="1"/></div>
        <div><label>Victorias Ãºltimas 5 (Away)</label><input id="formAway" type="number" value="1" min="0" max="5" step="1"/></div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>Cuotas (introduce las que tengas)</h3>
      <div class="table-like">
        <div><label>1X2 - Local</label><input id="oddsHome" type="number" value="2.10" step="0.01"/></div>
        <div><label>1X2 - Empate</label><input id="oddsDraw" type="number" value="3.40" step="0.01"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>1X2 - Visitante</label><input id="oddsAway" type="number" value="3.80" step="0.01"/></div>
        <div><label>BTTS SÃ­</label><input id="oddsBTTS" type="number" value="1.90" step="0.01"/></div>
      </div>
      <div class="table-like" style="margin-top:8px">
        <div><label>Over 2.5</label><input id="oddsOver25" type="number" value="2.00" step="0.01"/></div>
        <div></div>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="recalc" class="btn">âš¡ Calcular recomendaciones</button>
        <button id="reset" class="btn">ðŸ”„ Reset valores</button>
      </div>
      <p class="small" style="margin-top:8px">Consejo: si tienes cuotas americanas conviÃ©rtelas a decimales antes de introducirlas.</p>
    </div>

    <div class="card">
      <h3>Resultados & Recomendaciones</h3>
      <div class="kpis">
        <div class="tile"><strong id="pHome">â€”</strong><div class="small">Prob. Local</div></div>
        <div class="tile"><strong id="pDraw">â€”</strong><div class="small">Prob. Empate</div></div>
        <div class="tile"><strong id="pAway">â€”</strong><div class="small">Prob. Visitante</div></div>
        <div class="tile"><strong id="pBTTS">â€”</strong><div class="small">Prob. BTTS</div></div>
        <div class="tile"><strong id="pO25">â€”</strong><div class="small">Prob. Over 2.5</div></div>
        <div class="tile"><strong id="expectedBest">â€”</strong><div class="small">Mejor EV</div></div>
      </div>

      <div class="sep"></div>
      <div id="details" class="recs small"></div>
    </div>
  </div>
</div>

<script>
// --- Utilidades ---
const $ = id => document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const formatPct = x => (100*x).toFixed(1) + '%';
const formatMoney = x => '$' + x.toFixed(2);
const MAX_GOALS_DEFAULT = 8;
function toDecimalOdds(v){ const a=parseFloat(v); return isNaN(a)||a<=0?1.01:a; }

// --- Poisson ---
const factCache=[0,0];
function logFactorial(n){ if(n<2) return 0; if(factCache[n]) return factCache[n]; let s=0; for(let i=2;i<=n;i++) s+=Math.log(i); factCache[n]=s; return s; }
function poissonPMF(k,lambda){ if(lambda<=0) return (k===0?1:0); return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k)); }

// --- Lambdas ---
function computeLambdas({gfHome, gaHome, gfAway, gaAway, leagueAvg, posHome, posAway, formHome, formAway}){
  const h_adv = clamp(gfHome/leagueAvg,0.5,1.4);
  let lambdaHome = Math.max(0,(gfHome*gaAway/leagueAvg)*h_adv);
  let lambdaAway = Math.max(0,(gfAway*gaHome/leagueAvg));
  const posDiff = posAway - posHome;
  const posFactor = clamp(1 + (posDiff/40),0.9,1.12);
  lambdaHome *= posFactor; lambdaAway /= posFactor;
  const formHomeFactor = 1 + ((formHome-2.5)/25); const formAwayFactor = 1 + ((formAway-2.5)/25);
  lambdaHome *= clamp(formHomeFactor,0.85,1.12); lambdaAway *= clamp(formAwayFactor,0.85,1.12);
  lambdaHome = clamp(lambdaHome,0,6); lambdaAway = clamp(lambdaAway,0,6);
  return {lambdaHome, lambdaAway, h_adv, posFactor};
}

// --- 1X2 ---
function compute1X2(lambdaHome, lambdaAway, maxGoals){
  const pHomeGoals=[], pAwayGoals=[];
  for(let i=0;i<=maxGoals;i++){pHomeGoals[i]=poissonPMF(i,lambdaHome);pAwayGoals[i]=poissonPMF(i,lambdaAway);}
  const tailHome = 1 - pHomeGoals.reduce((a,b)=>a+b,0);
  const tailAway = 1 - pAwayGoals.reduce((a,b)=>a+b,0);
  pHomeGoals[maxGoals]+=tailHome; pAwayGoals[maxGoals]+=tailAway;
  let pHomeWin=0,pDraw=0,pAwayWin=0;
  for(let i=0;i<=maxGoals;i++)for(let j=0;j<=maxGoals;j++){const p=pHomeGoals[i]*pAwayGoals[j]; if(i>j)pHomeWin+=p; else if(i===j)pDraw+=p; else pAwayWin+=p;}
  const total=pHomeWin+pDraw+pAwayWin;
  return {pHomeWin:pHomeWin/total,pDraw:pDraw/total,pAwayWin:pAwayWin/total};
}

// --- BTTS & Over2.5 ---
function computeBTTS(lambdaHome,lambdaAway){
  const pNoHome=Math.exp(-lambdaHome);
  const pNoAway=Math.exp(-lambdaAway);
  const pBTTS=1 - pNoHome - pNoAway + pNoHome*pNoAway;
  const lT=lambdaHome+lambdaAway;
  const p0=poissonPMF(0,lT), p1=poissonPMF(1,lT), p2=poissonPMF(2,lT);
  const pOver25=1-(p0+p1+p2);
  return {pBTTS,pOver25};
}

// --- EV & Kelly ---
function expectedValue(p,odds){return p*(odds-1)-(1-p);}
function kellyFraction(p,odds){const b=odds-1; const q=1-p; if(b<=0)return 0; const f=(b*p-q)/b; return clamp(f,0,1);}

// --- Storage Banca ---
function getBankrollFromStorage(){try{const saved=JSON.parse(localStorage.getItem('calc_bankroll_v1')||'null'); if(!saved)return null; const now=new Date(); if(saved.month!==now.getMonth()||saved.year!==now.getFullYear())return null; return saved.value;}catch(e){return null;}}
function saveBankrollToStorage(value){try{const now=new Date(); const obj={value:Number(value),month:now.getMonth(),year:now.getFullYear()}; localStorage.setItem('calc_bankroll_v1',JSON.stringify(obj));}catch(e){}}

// --- Inputs ---
function gatherInputs(){
  return {
    teamHome:$('teamHome').value||'Local',
    teamAway:$('teamAway').value||'Visitante',
    posHome:Number($('posHome').value)||10,
    posAway:Number($('posAway').value)||10,
    gfHome:Number($('gfHome').value)||1.0,
    gaHome:Number($('gaHome').value)||1.0,
    gfAway:Number($('gfAway').value)||1.0,
    gaAway:Number($('gaAway').value)||1.0,
    formHome:Number($('formHome').value)||2,
    formAway:Number($('formAway').value)||2,
    leagueAvg:Number($('leagueAvg').value)||1.35,
    maxGoals:Math.max(4,Number($('maxGoals').value)||MAX_GOALS_DEFAULT),
    oddsHome:toDecimalOdds($('oddsHome').value),
    oddsDraw:toDecimalOdds($('oddsDraw').value),
    oddsAway:toDecimalOdds($('oddsAway').value),
    oddsBTTS:toDecimalOdds($('oddsBTTS').value),
    oddsOver25:toDecimalOdds($('oddsOver25').value),
    bankroll:Number($('bankroll').value)||0
  };
}

// --- Render ---
function renderRecommendations(result){
  const details=$('details'); details.innerHTML='';
  const info=document.createElement('div'); info.className='small';
  info.innerHTML=`<strong>Lambdas:</strong> Î»A=${result.lambdaHome.toFixed(2)} Î»B=${result.lambdaAway.toFixed(2)}<br/><strong>Ventaja casa (h):</strong> ${result.h_adv.toFixed(2)} â€¢ <strong>posFactor:</strong> ${result.posFactor.toFixed(3)}`;
  details.appendChild(info);
  const markets=result.markets.slice().sort((a,b)=>b.ev-a.ev);
  const list=document.createElement('div'); list.style.marginTop='8px';
  markets.forEach(m=>{
    const el=document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid #2a2e4a'; el.style.borderRadius='8px'; el.style.marginBottom='6px';
    el.innerHTML=`<strong>${m.name}</strong> â€” Prob: ${formatPct(m.p)} â€¢ Cuota: ${m.odds.toFixed(2)} â€¢ EV/u: ${(m.ev>=0?'+':'')+m.ev.toFixed(3)} â€¢ Kelly: ${(m.kelly*100).toFixed(2)}% â€¢ Stake recomendado: ${formatMoney(m.stake)} ${m.ev>0?'<span class="good">â–¶ sugerido</span>':''}`;
    list.appendChild(el);
  });
  details.appendChild(list);
  const best=markets.find(m=>m.ev>0); $('expectedBest').textContent=best?best.name:'Ninguno (EV negativo)';
}

// --- Run Calc ---
function runCalculation(){
  const inps=gatherInputs();
  const lamb=computeLambdas({gfHome:inps.gfHome,gaHome:inps.gaHome,gfAway:inps.gfAway,gaAway:inps.gaAway,leagueAvg:inps.leagueAvg,posHome:inps.posHome,posAway:inps.posAway,formHome:inps.formHome,formAway:inps.formAway});
  const res1x2=compute1X2(lamb.lambdaHome,lamb.lambdaAway,inps.maxGoals);
  const resBtts=computeBTTS(lamb.lambdaHome,lamb.lambdaAway);
  $('pHome').textContent=formatPct(res1x2.pHomeWin); $('pDraw').textContent=formatPct(res1x2.pDraw); $('pAway').textContent=formatPct(res1x2.pAwayWin);
  $('pBTTS').textContent=formatPct(resBtts.pBTTS); $('pO25').textContent=formatPct(resBtts.pOver25);
  const markets=[
    {name:'1X2 Local',p:res1x2.pHomeWin,odds:inps.oddsHome},
    {name:'1X2 Empate',p:res1x2.pDraw,odds:inps.oddsDraw},
    {name:'1X2 Visitante',p:res1x2.pAwayWin,odds:inps.oddsAway},
    {name:'BTTS SÃ­',p:resBtts.pBTTS,odds:inps.oddsBTTS},
    {name:'Over 2.5',p:resBtts.pOver25,odds:inps.oddsOver25}
  ];
  markets.forEach(m=>{m.ev=expectedValue(m.p,m.odds); m.kelly=kellyFraction(m.p,m.odds); m.stake=inps.bankroll*m.kelly;});
  renderRecommendations({...lamb,markets});
}

// --- Liga / Equipo ---
const teamsByLeague = {
  ligaMX:["AmÃ©rica","Atlas","AtlÃ©tico San Luis","Bravos","Cruz Azul","FC JuÃ¡rez","LeÃ³n","MazatlÃ¡n","Monterrey","Necaxa","Puebla","Santos Laguna","Tigres UANL","Toluca","Tijuana","Pachuca","QuerÃ©taro","San Luis","Chivas","Atlante","Pumas UNAM"],
  MLS:["Atlanta United","Austin FC","Charlotte FC","Chicago Fire","Colorado Rapids","Columbus Crew","D.C. United","FC Cincinnati","FC Dallas","Houston Dynamo","Inter Miami CF","LA Galaxy","LAFC","Minnesota United","Montreal Impact","Nashville SC","New England Revolution","New York City FC","New York Red Bulls","Orlando City SC","Philadelphia Union","Portland Timbers","Real Salt Lake","San Jose Earthquakes","Seattle Sounders FC","St. Louis City SC","Toronto FC","Vancouver Whitecaps FC","San Diego Loyal","Sacramento Republic FC"],
  LaLiga:["AtlÃ©tico de Madrid","Getafe","Rayo Vallecano","Real Madrid","Barcelona","Espanyol","Girona","Real Betis","Sevilla","Villarreal","Valencia","Elche","Levante","Real Oviedo","AlavÃ©s","Athletic Club","Real Sociedad","Celta de Vigo","Mallorca","Osasuna"],
  SerieA:["Atalanta","Bolonia","Cagliari","Cremonense","Empoli","Fiorentina","Genoa","Inter de MilÃ¡n","Juventus","Lazio","Lecce","Milan","Monza","Napoli","Roma","Salernitana","Sampdoria","Sassuolo","Spezia","Torino"],
  PL:["Arsenal","Aston Villa","Bournemouth","Brentford","Brighton & Hove Albion","Chelsea","Crystal Palace","Everton","Fulham","Leeds United","Liverpool","Manchester City","Manchester United","Newcastle United","Nottingham Forest","Sheffield United","Tottenham Hotspur","West Ham United","Wolverhampton Wanderers"],
  Ligue1:["Paris Saint-Germain","Olympique de Marsella","AS Monaco","Olympique de Lyon","Lille OSC","OGC Niza","RC Lens","Stade Rennais","FC Nantes","FC Lorient","Angers SCO","AS Saint-Ã‰tienne","Clermont Foot","Troyes AC","Reims","Montpellier HSC","Brest","Ajaccio"],
  Bundesliga:["Bayer Leverkusen","Bayern MÃºnich","Borussia Dortmund","Borussia MÃ¶nchengladbach","Colonia","Eintracht Frankfurt","Freiburgo","Hoffenheim","Mainz 05","RB Leipzig","Bayer 04 Leverkusen","VfB Stuttgart","Wolfsburgo","Augsburgo","Heidenheim","Hannover 96","Schalke 04","Werder Bremen"],
  Guatemala:["Antigua GFC","CobÃ¡n Imperial","XelajÃº MC","Municipal","Comunicaciones","Malacateco","Guastatoya","Sanarate","Achuapa","Santa LucÃ­a Cotzumalguapa","SololÃ¡","Mixco"]
};

const leagueSelect = $('leagueSelect');
const teamHome = $('teamHome');
const teamAway = $('teamAway');
leagueSelect.addEventListener('change',()=>{
  const l=leagueSelect.value;
  teamHome.innerHTML='<option value="">-- Selecciona equipo --</option>';
  teamAway.innerHTML='<option value="">-- Selecciona equipo --</option>';
  if(!l || !teamsByLeague[l]) return;
  teamsByLeague[l].forEach(t=>{
    const opt1=document.createElement('option'); opt1.value=t; opt1.textContent=t; teamHome.appendChild(opt1);
    const opt2=document.createElement('option'); opt2.value=t; opt2.textContent=t; teamAway.appendChild(opt2);
  });
});

// --- Botones ---
$('recalc').addEventListener('click', runCalculation);
$('reset').addEventListener('click',()=>{document.querySelectorAll('input').forEach(i=>i.value=i.defaultValue); runCalculation();});
$('saveBank').addEventListener('click',()=>{const v=Number($('bankroll').value)||0; saveBankrollToStorage(v); alert('Banca guardada');});

// --- Load banca ---
const savedBank=getBankrollFromStorage();
if(savedBank!==null) $('bankroll').value=savedBank;

</script>
</body>
</html>
