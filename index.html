<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calculadora Poisson + Kelly Reactiva</title>
<style>
body{font-family:sans-serif;background:#111;color:#eee;padding:20px;}
input{width:80px;margin:4px;}
.result{margin-top:12px;padding:10px;border:1px solid #444;}
.best{color:#6ee7a1;font-weight:bold;}
</style>
</head>
<body>

<h2>Calculadora de apuestas reactiva</h2>

<div>
  <label>GF local:</label><input class="inp" id="gfHome" value="1.6">
  <label>GC local:</label><input class="inp" id="gaHome" value="1.1"><br>
  <label>GF visitante:</label><input class="inp" id="gfAway" value="1.4">
  <label>GC visitante:</label><input class="inp" id="gaAway" value="1.2"><br>
  <label>Media liga:</label><input class="inp" id="leagueAvg" value="1.35">
  <label>Max goles:</label><input class="inp" id="maxGoals" value="8"><br>
  <label>Cuota Local:</label><input class="inp" id="oddsHome" value="2.1">
  <label>Cuota Empate:</label><input class="inp" id="oddsDraw" value="3.4">
  <label>Cuota Visitante:</label><input class="inp" id="oddsAway" value="3.8"><br>
  <label>Cuota BTTS:</label><input class="inp" id="oddsBTTS" value="1.9">
  <label>Cuota Over2.5:</label><input class="inp" id="oddsOver25" value="2.0">
</div>

<div id="result" class="result"></div>

<script>
const $ = id => document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const poissonPMF = (k,lambda)=> Math.exp(-lambda + k*Math.log(lambda) - (k<2?0:Array.from({length:k-1},(_,i)=>i+2).reduce((s,n)=>s+Math.log(n),0)));

// EV & Kelly
const expectedValue = (p,odds)=>p*(odds-1)-(1-p);
const kellyFraction = (p,odds)=>clamp(((odds-1)*p-(1-p))/(odds-1),0,1);

function computeLambdas(gfHome,gaHome,gfAway,gaAway,leagueAvg){
  let lambdaHome = (gfHome*gaAway/leagueAvg) * clamp(gfHome/leagueAvg,0.5,1.4);
  let lambdaAway = (gfAway*gaHome/leagueAvg);
  return {lambdaHome: clamp(lambdaHome,0,6), lambdaAway: clamp(lambdaAway,0,6)};
}

function compute1X2(lambdaHome,lambdaAway,maxGoals){
  const pH=[],pA=[];
  for(let i=0;i<=maxGoals;i++){ pH[i]=poissonPMF(i,lambdaHome); pA[i]=poissonPMF(i,lambdaAway);}
  const tailH=1-pH.reduce((a,b)=>a+b,0), tailA=1-pA.reduce((a,b)=>a+b,0);
  pH[maxGoals]+=tailH; pA[maxGoals]+=tailA;
  let winH=0,draw=0,winA=0;
  for(let i=0;i<=maxGoals;i++) for(let j=0;j<=maxGoals;j++){
    const p=pH[i]*pA[j];
    if(i>j) winH+=p; else if(i===j) draw+=p; else winA+=p;
  }
  return {pHome:winH,pDraw:draw,pAway:winA};
}

function computeBTTS(lambdaHome,lambdaAway){
  const pNoH=Math.exp(-lambdaHome), pNoA=Math.exp(-lambdaAway);
  const pBTTS=1 - pNoH - pNoA + pNoH*pNoA;
  const lT=lambdaHome+lambdaAway;
  const p0=poissonPMF(0,lT), p1=poissonPMF(1,lT), p2=poissonPMF(2,lT);
  const pOver25=1-(p0+p1+p2);
  return {pBTTS,pOver25};
}

function runCalc(){
  const gfH=parseFloat($('gfHome').value), gaH=parseFloat($('gaHome').value),
        gfA=parseFloat($('gfAway').value), gaA=parseFloat($('gaAway').value),
        leagueAvg=parseFloat($('leagueAvg').value), maxG=parseInt($('maxGoals').value),
        oddsH=parseFloat($('oddsHome').value), oddsD=parseFloat($('oddsDraw').value),
        oddsA=parseFloat($('oddsAway').value), oddsBT=parseFloat($('oddsBTTS').value),
        oddsO=parseFloat($('oddsOver25').value);

  const {lambdaHome,lambdaAway}=computeLambdas(gfH,gaH,gfA,gaA,leagueAvg);
  const {pHome,pDraw,pAway}=compute1X2(lambdaHome,lambdaAway,maxG);
  const {pBTTS,pOver25}=computeBTTS(lambdaHome,lambdaAway);

  const markets = [
    {name:'1', p:pHome, odds:oddsH},
    {name:'X', p:pDraw, odds:oddsD},
    {name:'2', p:pAway, odds:oddsA},
    {name:'BTTS', p:pBTTS, odds:oddsBT},
    {name:'Over2.5', p:pOver25, odds:oddsO}
  ];

  markets.forEach(m=>{ m.ev=expectedValue(m.p,m.odds); m.kelly=kellyFraction(m.p,m.odds); });

  const best = markets.reduce((a,b)=>b.ev>a.ev?b:a,markets[0]);

  $('result').innerHTML = markets.map(m=>{
    const cls = (m===best)?'best':'';
    return `<div class="${cls}">${m.name}: ${(m.p*100).toFixed(1)}% | EV: ${m.ev.toFixed(2)} | Kelly: ${(m.kelly*100).toFixed(1)}%</div>`;
  }).join('');
}

// Recalcular automáticamente al cambiar cualquier input
document.querySelectorAll('.inp').forEach(el=>el.addEventListener('input', runCalc));

// Calcular al cargar la página
runCalc();
</script>
</body>
</html>
