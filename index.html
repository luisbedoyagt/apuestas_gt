<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculadora Apuestas Avanzada • Poisson + Kelly</title>
<style>
:root{--gap:12px;--radius:10px;--bg:#0f1220;--card:#191c2f;--muted:rgba(230,233,245,.75);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6e9f5}
.container{max-width:1100px;margin:24px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:var(--gap)}
.header{text-align:center;padding:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:var(--card);border:1px solid #2a2e4a;padding:12px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.08)}
label{font-size:13px;opacity:.95}
input,select{width:100%;padding:6px;border-radius:8px;border:1px solid #2a2e4a;background:var(--bg);color:inherit}
.row{display:flex;gap:10px}
.row > *{flex:1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{text-align:center;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2a2e4a}
.small{font-size:12px;color:var(--muted)}
.btn {padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(135deg,#4f46e5,#6366f1);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s ease-in-out;box-shadow:0 4px 12px rgba(0,0,0,0.25);}
.btn:hover {transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.35);}
.btn:active {transform:translateY(1px);box-shadow:0 3px 10px rgba(0,0,0,0.25);}
#saveBank {background:linear-gradient(135deg,#ef4444,#f87171);}
#clearAll {background:linear-gradient(135deg,#ef6f6f,#fb8b8b);}
.sep{height:1px;background:#2a2e4a;margin:8px 0}
.recs{display:grid;gap:6px}
.bad{color:#f87171}.good{color:#6ee7a1}.neutral{color:#93c5fd}
.table-like{display:grid;grid-template-columns:1fr 1fr;gap:6px}
@media(max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Calculadora Apuestas Avanzada • Poisson + Kelly</h1>
    <p class="small">Introduce estadísticas por equipo (pos., GF/GC local/visitante, forma). La herramienta recomienda mercados y stake según EV + Kelly.</p>
  </div>

  <div class="grid">
    <!-- Banco mensual y parámetros -->
    <div class="card">
      <h3>Banco mensual</h3>
      <div class="table-like">
        <div>
          <label>Banca actual (Q)</label>
          <input id="bankroll" type="number" value="1000" min="0" step="1"/>
        </div>
        <div>
          <label>Guarda / Actualiza</label><br/>
          <button id="saveBank" class="btn">Guardar banca</button>
        </div>
      </div>
      <p class="small">La banca se guarda en tu navegador y se resetea si cambia el mes.</p>
      <div class="sep"></div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
        <button id="recalc" class="btn">Calcular recomendaciones</button>
        <button id="reset" class="btn">Reset valores</button>
        <button id="clearAll" class="btn">Resetear todo</button>
      </div>
    </div>

    <!-- Cuotas -->
    <div class="card">
      <h3>Cuotas (introduce las que tengas)</h3>
      <div class="table-like">
        <div><label>1X2 - Local</label><input id="oddsHome" type="number" value="2.10" step="0.01" min="1"/></div>
        <div><label>1X2 - Empate</label><input id="oddsDraw" type="number" value="3.40" step="0.01" min="1"/></div>
      </div>
      <div class="table-like" style="margin-top:6px">
        <div><label>1X2 - Visitante</label><input id="oddsAway" type="number" value="3.80" step="0.01" min="1"/></div>
        <div><label>BTTS Sí</label><input id="oddsBTTS" type="number" value="1.90" step="0.01" min="1"/></div>
      </div>
      <div class="table-like" style="margin-top:6px">
        <div><label>Over 2.5</label><input id="oddsOver25" type="number" value="2.00" step="0.01" min="1"/></div>
        <div></div>
      </div>
      <p class="small" style="margin-top:6px">Consejo: si tienes cuotas americanas conviértelas a decimales antes de introducirlas.</p>
    </div>
  </div>

  <!-- Equipos y estadísticas -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>Equipos y estadísticas</h3>
      <div class="table-like">
        <div>
          <label>Liga</label>
          <select id="leagueSelect"><option value="">-- Selecciona liga --</option></select>
        </div>
      </div>
      <div class="table-like" style="margin-top:6px">
        <div>
          <label>Equipo Local</label>
          <select id="teamHome"></select>
        </div>
        <div>
          <label>Equipo Visitante</label>
          <select id="teamAway"></select>
        </div>
      </div>
      <div class="sep"></div>
      <h4>Posición en la tabla</h4>
      <div class="table-like">
        <div><label>Pos Local (1 = mejor)</label><input id="posHome" type="number" value="5" min="1" step="1"/></div>
        <div><label>Pos Visitante</label><input id="posAway" type="number" value="12" min="1" step="1"/></div>
      </div>
      <div class="sep"></div>
      <h4>Promedios (por partido)</h4>
      <div class="table-like">
        <div><label>GF local</label><input id="gfHome" type="number" value="1.6" step="0.01" min="0"/></div>
        <div><label>GC local</label><input id="gaHome" type="number" value="1.1" step="0.01" min="0"/></div>
      </div>
      <div class="table-like" style="margin-top:6px">
        <div><label>GF visitante</label><input id="gfAway" type="number" value="1.4" step="0.01" min="0"/></div>
        <div><label>GC visitante</label><input id="gaAway" type="number" value="1.2" step="0.01" min="0"/></div>
      </div>
      <div class="sep"></div>
      <h4>Forma (últimos 5)</h4>
      <div class="table-like">
        <div><label>Victorias últimas 5 (Local)</label><input id="formHome" type="number" value="3" min="0" max="5" step="1"/></div>
        <div><label>Victorias últimas 5 (Away)</label><input id="formAway" type="number" value="1" min="0" max="5" step="1"/></div>
      </div>
    </div>
  </div>

  <!-- Resultados y recomendaciones -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>Resultados & Recomendaciones</h3>
      <div class="kpis">
        <div class="tile"><strong id="pHome">—</strong><div class="small">Prob. Local</div></div>
        <div class="tile"><strong id="pDraw">—</strong><div class="small">Prob. Empate</div></div>
        <div class="tile"><strong id="pAway">—</strong><div class="small">Prob. Visitante</div></div>
        <div class="tile"><strong id="pBTTS">—</strong><div class="small">Prob. BTTS</div></div>
        <div class="tile"><strong id="pO25">—</strong><div class="small">Prob. Over 2.5</div></div>
        <div class="tile"><strong id="expectedBest">—</strong><div class="small">Mejor EV</div></div>
      </div>
      <div class="sep"></div>
      <div id="details" class="recs small"></div>
      <div id="matchStats" class="recs small neutral"></div>
      <div style="margin-top:6px;" id="suggestion" class="recs small good"></div>
      <div class="sep"></div>
      <div class="recs small">
        <strong>Guía abreviaturas:</strong><br/>
        EV: Expected Value (Valor Esperado), JJ: Partidos Jugados, G: Ganados, E: Empatados, P: Perdidos, Stake: Monto sugerido
      </div>
    </div>
  </div>
</div>

<script>
// ----------------- Utilidades -----------------
const $ = id => document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const formatPct = x => (100*x).toFixed(1)+'%';
function toDecimalOdds(v){ const a=parseFloat(String(v).replace(/,/g,'.')); return isNaN(a)||a<=0?1.01:a; }
function parseNumberString(val){ return parseFloat(String(val||'').replace(/,/g,'.'))||0; }

// ----------------- Web App / Autollenado -----------------
const leagueSelect = $('leagueSelect');
const teamHome = $('teamHome');
const teamAway = $('teamAway');
let teamsByLeague = {};

const leagueNames = {
  "WC": "FIFA World Cup",
  "CL": "UEFA Champions League",
  "BL1": "Bundesliga",
  "DED": "Eredivisie",
  "BSA": "Campeonato Brasileiro Série A",
  "PD": "Liga Española",
  "FL1": "Ligue 1",
  "ELC": "Championship",
  "PPL": "Primeira Liga / Portugal",
  "EC": "European Championship",
  "SA": "Serie A",
  "PL": "Premier League"
};

async function cargarEquiposDesdeWebApp() {
  const url = "https://script.google.com/macros/s/AKfycbyP6dc9ww4I9kw26fQCc0gAyEtYbQVg6DsoAtlnxqhFFJClOrHoudM8PdnBnT9YBopSlA/exec";
  try { const resp = await fetch(url); return await resp.json(); }
  catch(e){ console.error("Error cargando equipos:", e); return {}; }
}

document.addEventListener('DOMContentLoaded', async () => {
  teamsByLeague = await cargarEquiposDesdeWebApp();
  Object.keys(teamsByLeague).forEach(codigo=>{
    const opt = document.createElement('option'); opt.value=codigo; opt.textContent=leagueNames[codigo]||codigo; leagueSelect.appendChild(opt);
  });

  const savedBank = localStorage.getItem('bankroll'); if(savedBank) $('bankroll').value = savedBank;

  leagueSelect.addEventListener('change',()=>{
    const l=leagueSelect.value;
    teamHome.innerHTML=teamAway.innerHTML='<option value="">-- Selecciona equipo --</option>';
    if(!l||!teamsByLeague[l]) return;
    teamsByLeague[l].forEach(t=>{
      const opt1=document.createElement('option'); opt1.value=t.name; opt1.textContent=t.name; teamHome.appendChild(opt1);
      const opt2=document.createElement('option'); opt2.value=t.name; opt2.textContent=t.name; teamAway.appendChild(opt2);
    });
  });

  function fillTeamData(teamName, leagueCode, type){
    if(!teamsByLeague[leagueCode]) return;
    const teamData = teamsByLeague[leagueCode].find(t=>t.name===teamName);
    if(!teamData) return;
    if(type==='Home'){
      $('posHome').value=teamData.pos;
      $('gfHome').value=teamData.gf;
      $('gaHome').value=teamData.ga;
      $('formHome').value=teamData.form;
    } else {
      $('posAway').value=teamData.pos;
      $('gfAway').value=teamData.gf;
      $('gaAway').value=teamData.ga;
      $('formAway').value=teamData.form;
    }
    calculateAll();
  }

  teamHome.addEventListener('change',()=>fillTeamData(teamHome.value,leagueSelect.value,'Home'));
  teamAway.addEventListener('change',()=>fillTeamData(teamAway.value,leagueSelect.value,'Away'));

  $('recalc').addEventListener('click',()=>calculateAll());
  $('reset').addEventListener('click',()=>location.reload());
  $('clearAll').addEventListener('click',()=>{
    document.querySelectorAll('input').forEach(i=>i.value='');
    document.querySelectorAll('select').forEach(s=>s.selectedIndex=0);
    ['pHome','pDraw','pAway','pBTTS','pO25','expectedBest','details','matchStats','suggestion'].forEach(id=>$$(id).textContent='—');
  });

  $('saveBank').addEventListener('click',()=>{
    const bank=parseNumberString($('bankroll').value);
    localStorage.setItem('bankroll',bank);
    alert(`Banca guardada: Q${bank}`);
  });
});

// ----------------- Funciones Poisson & Kelly -----------------
function logFactorial(n){return n<=1?0:Math.log(n)+logFactorial(n-1);}
function poissonPMF(lambda,k){return Math.exp(-lambda + k*Math.log(lambda) - logFactorial(k));}
function compute1X2(lambdaHome,lambdaAway,maxGoals=8){let pHome=0,pDraw=0,pAway=0;for(let i=0;i<=maxGoals;i++){for(let j=0;j<=maxGoals;j++){const prob=poissonPMF(lambdaHome,i)*poissonPMF(lambdaAway,j);if(i>j)pHome+=prob;else if(i===j)pDraw+=prob;else pAway+=prob;}}return {pHome,pDraw,pAway};}
function computeBTTS(lambdaHome,lambdaAway){let p=0;for(let i=1;i<=8;i++){for(let j=1;j<=8;j++){p+=poissonPMF(lambdaHome,i)*poissonPMF(lambdaAway,j);}}return p;}
function computeOver25(lambdaHome,lambdaAway,maxGoals=8){let p=0;for(let i=0;i<=maxGoals;i++){for(let j=0;j<=maxGoals;j++){if(i+j>2)p+=poissonPMF(lambdaHome,i)*poissonPMF(lambdaAway,j);}}return p;}
function kellyFraction(p,odds){return Math.max(0,(p*odds-1)/(odds-1));}

// ----------------- Calcular & Renderizar -----------------
function calculateAll(){
  const lambdaHome=parseNumberString($('gfHome').value);
  const lambdaAway=parseNumberString($('gfAway').value);
  const {pHome,pDraw,pAway}=compute1X2(lambdaHome,lambdaAway);
  const pBTTS=computeBTTS(lambdaHome,lambdaAway);
  const pO25=computeOver25(lambdaHome,lambdaAway);

  $('pHome').textContent=formatPct(pHome);
  $('pDraw').textContent=formatPct(pDraw);
  $('pAway').textContent=formatPct(pAway);
  $('pBTTS').textContent=formatPct(pBTTS);
  $('pO25').textContent=formatPct(pO25);

  const bankroll=parseNumberString($('bankroll').value);

  const evs=[
    {name:'Local',p:pHome,odds:toDecimalOdds($('oddsHome').value)},
    {name:'Empate',p:pDraw,odds:toDecimalOdds($('oddsDraw').value)},
    {name:'Visitante',p:pAway,odds:toDecimalOdds($('oddsAway').value)},
    {name:'BTTS',p:pBTTS,odds:toDecimalOdds($('oddsBTTS').value)},
    {name:'Over2.5',p:pO25,odds:toDecimalOdds($('oddsOver25').value)}
  ];

  evs.forEach(e=>e.ev=e.p*e.odds-1);
  evs.forEach(e=>e.stake=kellyFraction(e.p,e.odds)*bankroll);
  evs.sort((a,b)=>b.ev-a.ev);

  $('expectedBest').textContent=evs[0].name;
  $('details').innerHTML=evs.map(e=>`${e.name}: EV ${e.ev.toFixed(2)}, Stake Q${e.stake.toFixed(0)}`).join('<br/>');

  // Mostrar JJ, G, E, P
  function showMatchStats(teamName, leagueCode){
    if(!teamsByLeague[leagueCode]) return '';
    const t=teamsByLeague[leagueCode].find(x=>x.name===teamName);
    if(!t) return '';
    return `JJ: ${t.played||0}, G: ${t.won||0}, E: ${t.drawn||0}, P: ${t.lost||0}`;
  }
  $('matchStats').innerHTML=`
    Local (${teamHome.value}): ${showMatchStats(teamHome.value, leagueSelect.value)}<br/>
    Visitante (${teamAway.value}): ${showMatchStats(teamAway.value, leagueSelect.value)}
  `;

  // Apuesta sugerida
  $('suggestion').textContent=`Apuesta sugerida: ${evs[0].name} con stake Q${evs[0].stake.toFixed(0)}`;
}
</script>
</body>
</html>
