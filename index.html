<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculadora Apuestas Avanzada (xG Poisson)</title>
<style>
  :root { --gap: 12px; --radius: 12px; --shadow: 0 6px 18px rgba(0,0,0,.08); }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin:0; background:#0f1220; color:#e6e9f5; }
  header { padding: 24px; text-align:center; }
  header h1{ margin:0 0 6px; font-size: clamp(20px, 3vw, 28px); }
  header p { margin:0; opacity:.8; font-size: 14px; }
  main { max-width: 1100px; margin: 0 auto; padding: 18px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--gap); }
  section, .card { background: #191c2f; border: 1px solid #2a2e4a; border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
  h2 { font-size: 16px; margin: 0 0 10px; letter-spacing: .3px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  label { font-size: 12px; opacity:.9; }
  input, select { width: 100%; padding: 10px; border-radius: 10px; background:#0f1220; border:1px solid #2a2e4a; color:#e6e9f5; }
  .muted { opacity:.75; font-size:12px; }
  .kpi { display:grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
  .kpi .tile { background:#0f1220; border:1px solid #2a2e4a; padding:12px; border-radius:10px; text-align:center; }
  .tile h3 { margin:0; font-size: 22px; }
  .tile p { margin:6px 0 0; opacity:.8; font-size:12px; }
  .good { color: #6ee7a1; }
  .bad { color: #f87171; }
  .neutral { color: #93c5fd; }
  .btn { padding:10px 14px; border-radius:10px; border:1px solid #2a2e4a; background:#0f1220; color:#e6e9f5; cursor:pointer; }
  .footer { max-width:1100px; margin:0 auto 24px; padding:0 18px; opacity:.7; font-size:12px; }
  .sep { height:1px; background:#2a2e4a; margin: 12px 0; }
</style>
</head>
<body>
<header>
  <h1>Calculadora Apuestas Avanzada • Poisson + Kelly</h1>
  <p>Introduce datos de goles, cuotas y banca. El sistema recomienda probabilidad, valor esperado, stake y mercado óptimo.</p>
</header>

<main>
  <section>
    <h2>Banca mensual</h2>
    <div class="grid">
      <div><label>Banca actual</label><input id="bankroll" type="number" step="1" min="0" value="1000"></div>
      <div><label>Guardar banca</label><button class="btn" id="saveBank">Guardar</button></div>
    </div>
    <p class="muted">La banca se guarda en tu navegador al inicio del mes.</p>
  </section>

  <section>
    <h2>Cuotas</h2>
    <div class="grid">
      <div><label>BTTS Sí • Cuota</label><input id="oddsBTTS" type="number" step="0.01" min="1.01" value="1.90"></div>
      <div><label>Over 2.5 • Cuota</label><input id="oddsOver25" type="number" step="0.01" min="1.01" value="2.00"></div>
      <div><label>Victoria Local • Cuota</label><input id="oddsHome" type="number" step="0.01" min="1.01" value="2.20"></div>
      <div><label>Victoria Visitante • Cuota</label><input id="oddsAway" type="number" step="0.01" min="1.01" value="3.10"></div>
    </div>
  </section>

  <section>
    <h2>Resultados</h2>
    <div class="kpi">
      <div class="tile"><h3 id="pBTTS">—</h3><p>Prob. BTTS</p></div>
      <div class="tile"><h3 id="pO25">—</h3><p>Prob. Over 2.5</p></div>
      <div class="tile"><h3 id="evBTTS">—</h3><p>EV BTTS</p></div>
      <div class="tile"><h3 id="evO25">—</h3><p>EV Over 2.5</p></div>
      <div class="tile"><h3 id="kellyBTTS">—</h3><p>Kelly + Stake BTTS</p></div>
      <div class="tile"><h3 id="kellyO25">—</h3><p>Kelly + Stake Over</p></div>
    </div>
    <div class="sep"></div>
    <h3 id="recommendation">Mejor mercado: —</h3>
  </section>
</main>

<div class="footer">
  <p>Modelo didáctico. No garantiza resultados ni sustituye gestión de riesgo. Juega con responsabilidad.</p>
</div>

<script>
const $ = id => document.getElementById(id);
const formatPct = x => (100*x).toFixed(1)+'%';
const formatMoney = x => 'Q '+x.toFixed(2);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

function toDecimalOdds(value){return Math.max(parseFloat(value||0),1.01);}

function poissonPMF(k, lambda){
  if(lambda<=0) return k===0 ? 1:0;
  let logP=-lambda + k*Math.log(lambda) - logFactorial(k);
  return Math.exp(logP);
}
const factCache=[0,0];
function logFactorial(n){
  if(n<2) return 0;
  if(factCache[n]) return factCache[n];
  let sum=0; for(let i=2;i<=n;i++) sum+=Math.log(i);
  factCache[n]=sum; return sum;
}

function recompute(){
  const bank=parseFloat($('bankroll').value||0);

  const oddsBTTS=toDecimalOdds($('oddsBTTS').value);
  const oddsO25=toDecimalOdds($('oddsOver25').value);

  // Supongamos λA=1.5 y λB=1.3 (puedes automatizar con GF/GC)
  let lA=1.5, lB=1.3;

  const pNoA=Math.exp(-lA), pNoB=Math.exp(-lB), pNoBoth=Math.exp(-(lA+lB));
  const pBTTS=1-pNoA-pNoB+pNoBoth;

  const lT=lA+lB;
  const p0=poissonPMF(0,lT), p1=poissonPMF(1,lT), p2=poissonPMF(2,lT);
  const pOver25=1-(p0+p1+p2);

  const evBTTS=pBTTS*(oddsBTTS-1)-(1-pBTTS);
  const evO25=pOver25*(oddsO25-1)-(1-pOver25);

  function kelly(p,odds){const b=odds-1;const q=1-p;return clamp((b*p-q)/b,0,1);}
  const kBTTS=kelly(pBTTS, oddsBTTS);
  const kO25=kelly(pOver25, oddsO25);

  const stakeBTTS=bank*kBTTS;
  const stakeO25=bank*kO25;

  $('pBTTS').textContent=formatPct(pBTTS);
  $('pO25').textContent=formatPct(pOver25);
  $('evBTTS').textContent=(evBTTS>=0?'+':'')+evBTTS.toFixed(3);
  $('evO25').textContent=(evO25>=0?'+':'')+evO25.toFixed(3);
  $('kellyBTTS').textContent=(kBTTS*100).toFixed(1)+'% ('+formatMoney(stakeBTTS)+')';
  $('kellyO25').textContent=(kO25*100).toFixed(1)+'% ('+formatMoney(stakeO25)+')';

  // Recomendación de mercado óptimo
  let best="—";
  if(evBTTS>evO25 && evBTTS>0){best="BTTS";}
  else if(evO25>evBTTS && evO25>0){best="Over 2.5";}
  else best="Ninguno claro";
  $('recommendation').textContent="Mejor mercado: "+best;
}

// Guardar banca en localStorage
$('saveBank').addEventListener('click', ()=>{
  const bank=$('bankroll').value;
  localStorage.setItem('bankroll',bank);
  alert("Banca guardada: "+bank);
});

window.onload=()=>{
  const saved=localStorage.getItem('bankroll');
  if(saved){$('bankroll').value=saved;}
  recompute();
};
document.addEventListener('input',recompute);
</script>
</body>
</html>
